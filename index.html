<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>NST Trip Sheet</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Poppins', sans-serif;
      margin: 0 auto;
      padding: 20px;
      max-width: 800px;
      background: #f4f6f9;
    }
    h2 { color: #4b2aad; }
    label {
      font-weight: bold;
      margin-top: 10px;
      display: block;
    }
    input, select, textarea, button {
      width: 100%;
      padding: 10px;
      margin: 5px 0 15px 0;
      border: 1px solid #ccc;
      border-radius: 5px;
      font-size: 16px;
    }
    button {
      background: #4b2aad;
      color: white;
      border: none;
      cursor: pointer;
    }
    button:hover {
      background: #3a208b;
    }
  </style>
</head>
<body>
  <h2>üìù NST Trip Sheet</h2>

  <label>Trip ID</label><input id="tripId" readonly>

  <label>Date</label>
  <input type="text" id="tripDateDisplay" placeholder="Select Date" readonly style="cursor: pointer;">
  <input type="date" id="tripDate" style="display:none;">

  <label>Customer Name</label><input id="custName">
  <label>Customer Number</label><input id="custNumber">
  <label>Driver Name</label><input id="driverName">
  <label>Driver Number</label><input id="driverNumber">

  <label>Vehicle Model</label>
  <select id="vehicleModel" onchange="sync(true)">
    <option value="">-- Select --</option>
    <option>Innova Crysta</option>
    <option>Innova Hycross</option>
    <option>Force Urbania</option>
  </select>

  <label>Vehicle Number</label>
  <select id="vehicleNo" onchange="sync(false)">
    <option value="">-- Select --</option>
    <option>PY05N0505</option>
    <option>PY01DB1007</option>
    <option>TN14AP2084</option>
  </select>

  <label>Start Time</label><input type="time" id="startTime" onchange="recalc()">
  <label>End Time</label><input type="time" id="endTime" onchange="recalc()">
  <label>Duration (hrs)</label><input id="duration" readonly>
  <label>Extra Hours</label><input id="extraHours" readonly>
  <label>Start KM</label><input type="number" id="startKM" onchange="recalc()">
  <label>End KM</label><input type="number" id="endKM" onchange="recalc()">
  <label>Total KM</label><input id="totalKM" readonly>
  <label>Extra KM</label><input id="extraKM" readonly>

  <label>Parking ‚Çπ</label><input type="number" id="parking" value="0">
  <label>Toll ‚Çπ</label><input type="number" id="toll" value="0">

  <label>Note</label><textarea id="note" rows="3" placeholder="Enter any trip notes..."></textarea>

  <div style="margin-top: 15px;">
    <button onclick="shareWhatsApp()">üì§ Share via WhatsApp</button>
  </div>

  <input type="hidden" id="freeKm">

  <script>
    const rates = {
      "Innova Crysta": { free: 80, no: "PY05N0505" },
      "Innova Hycross": { free: 60, no: "PY01DB1007" },
      "Force Urbania": { free: 70, no: "TN14AP2084" }
    };

    function genId() {
      let n = parseInt(localStorage.getItem("trip-seq") || "1");
      return "#NST" + String(n).padStart(3, "0");
    }

    function reserveNextId() {
      let current = parseInt(localStorage.getItem("trip-seq") || "1");
      localStorage.setItem("#NST" + String(current).padStart(3, "0"), "used");
      localStorage.setItem("trip-seq", current + 1);
      tripId.value = genId();
    }

    function formatDate(dateStr) {
      const d = new Date(dateStr);
      const dd = String(d.getDate()).padStart(2, '0');
      const mm = String(d.getMonth() + 1).padStart(2, '0');
      const yyyy = d.getFullYear();
      return `${dd}-${mm}-${yyyy}`;
    }

    function to12Hr(timeStr) {
      if (!timeStr) return "";
      const [h, m] = timeStr.split(":");
      const d = new Date();
      d.setHours(h, m);
      return d.toLocaleTimeString('en-IN', {
        hour: '2-digit', minute: '2-digit', hour12: true, timeZone: 'Asia/Kolkata'
      });
    }

    function sync(fromModel) {
      if (fromModel) {
        let model = vehicleModel.value;
        if (rates[model]) {
          vehicleNo.value = rates[model].no;
          freeKm.value = rates[model].free;
        }
      } else {
        let no = vehicleNo.value;
        for (let model in rates) {
          if (rates[model].no === no) {
            vehicleModel.value = model;
            sync(true);
            break;
          }
        }
      }
      recalc();
    }

    function recalc() {
      if (startTime.value && endTime.value) {
        let s = new Date(`1970-01-01T${startTime.value}`);
        let e = new Date(`1970-01-01T${endTime.value}`);
        let diff = (e - s) / 3600000;
        if (diff < 0) diff += 24;
        let hrs = Math.ceil(diff);
        duration.value = hrs;
        extraHours.value = hrs > 8 ? hrs - 8 : 0;
      }

      let totKm = endKM.value - startKM.value;
      totalKM.value = totKm;
      extraKM.value = totKm > freeKm.value ? totKm - freeKm.value : 0;
    }

    function shareWhatsApp() {
      const rawDate = tripDateDisplay.dataset.raw;
      if (!rawDate) {
        alert("Please select a date before sharing.");
        return;
      }

      const msg = `üìã *TRIP SUMMARY*

*TRIP ID:* ${tripId.value}
*DATE:* ${formatDate(rawDate)}

üë§ *CUSTOMER INFO*
‚Ä¢ *Name:* ${custName.value}
‚Ä¢ *Number:* ${custNumber.value}

üë®‚Äç‚úàÔ∏è *DRIVER INFO*
‚Ä¢ *Name:* ${driverName.value}
‚Ä¢ *Number:* ${driverNumber.value}

üöò *VEHICLE INFO*
‚Ä¢ *Model:* ${vehicleModel.value}
‚Ä¢ *Vehicle No:* ${vehicleNo.value}

üïí *TIME & DISTANCE*
‚Ä¢ *Start Time:* ${to12Hr(startTime.value)}
‚Ä¢ *End Time:* ${to12Hr(endTime.value)}
‚Ä¢ *Duration:* ${duration.value || 0} hrs
‚Ä¢ *Extra Hrs:* ${extraHours.value || 0}
‚Ä¢ *Total KM:* ${totalKM.value || 0} km
‚Ä¢ *Extra KM:* ${extraKM.value || 0} km

üí∞ *CHARGES*
‚Ä¢ *Parking:* ‚Çπ${parking.value || 0}
‚Ä¢ *Toll:* ‚Çπ${toll.value || 0}

üìù *Note:* ${note.value || "-"}`;

      window.open("https://wa.me/?text=" + encodeURIComponent(msg), '_blank');

      setTimeout(() => {
        if (confirm("‚úÖ Did you successfully send the WhatsApp message?")) {
          reserveNextId();
        }
      }, 1000);
    }

    // Date Picker Logic
    const tripDateDisplay = document.getElementById("tripDateDisplay");
    const tripDateHidden = document.getElementById("tripDate");

    tripDateDisplay.addEventListener("click", () => {
      tripDateHidden.click();
    });

    tripDateHidden.addEventListener("change", () => {
      const raw = tripDateHidden.value;
      if (!raw) return;
      const d = new Date(raw);
      const display = d.toLocaleDateString("en-GB", {
        day: '2-digit',
        month: 'long',
        year: 'numeric',
        timeZone: 'Asia/Kolkata'
      });
      tripDateDisplay.value = display;
      tripDateDisplay.dataset.raw = raw;
    });

    // Initialize first trip ID
    tripId.value = genId();
  </script>
</body>
</html>
