<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>NST Trip Sheet ‚Äì Protected</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Poppins', sans-serif;
      margin: 0; padding: 0;
      background: #f5f5f5;
    }
    #loginScreen {
      max-width: 350px;
      margin: 100px auto;
      padding: 30px;
      border: 1px solid #ccc;
      background: white;
      text-align: center;
      border-radius: 8px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
    #loginScreen input {
      width: 100%;
      padding: 10px;
      margin-top: 15px;
      margin-bottom: 10px;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-size: 16px;
    }
    #loginScreen button {
      width: 100%;
      padding: 10px;
      background: #4b2aad;
      color: white;
      border: none;
      font-size: 16px;
      cursor: pointer;
      border-radius: 4px;
    }
    #loginScreen button:hover {
      background: #3a218d;
    }
    #protected {
      display: none;
      padding: 20px;
    }
    input, select, textarea, button {
      font-family: 'Poppins', sans-serif;
    }
  </style>
</head>
<body>

  <div id="loginScreen">
    <h2>üîí Password Required</h2>
    <p>Enter password to access the NST Trip Sheet</p>
    <input type="password" id="accessPassword" placeholder="Enter password" />
    <button onclick="checkPassword()">Login</button>
    <p id="loginError" style="color: red; display: none;">‚ùå Incorrect password</p>
  </div>

  <div id="protected">
    <!-- üìù NST Trip Sheet App content starts here -->
    <h2>üìù NST Trip Sheet</h2>
    <div id="mainForm">
      <label>Trip ID</label><input id="tripId" readonly>
      <label>Date</label><input type="date" id="tripDate">
      <label>Customer Name</label><input id="custName">
      <label>Customer Number</label><input id="custNumber">
      <label>Driver Name</label>
      <select id="driverName" onchange="syncDriver(true)">
        <option value="">-- Select --</option>
        <option>Perumal</option>
        <option>Siva</option>
      </select>
      <label>Driver Number</label>
      <select id="driverNumber" onchange="syncDriver(false)">
        <option value="">-- Select --</option>
        <option>9699994563</option>
        <option>9551208961</option>
      </select>
      <label>Vehicle Model</label>
      <select id="vehicleModel" onchange="sync(true)">
        <option value="">-- Select --</option>
        <option>Innova Crysta</option>
        <option>Innova Hycross</option>
        <option>Force Urbania</option>
      </select>
      <label>Vehicle Number</label>
      <select id="vehicleNo" onchange="sync(false)">
        <option value="">-- Select --</option>
        <option>PY05N0505</option>
        <option>PY01DB1007</option>
        <option>TN14AP2084</option>
      </select>
      <label>Start Time</label><input type="time" id="startTime" onchange="recalc()">
      <label>End Time</label><input type="time" id="endTime" onchange="recalc()">
      <label>Duration (hrs)</label><input id="duration" readonly>
      <label>Extra Hours</label><input id="extraHours" readonly>
      <label>Start KM</label><input type="number" id="startKM" onchange="recalc()">
      <label>End KM</label><input type="number" id="endKM" onchange="recalc()">
      <label>Total KM</label><input id="totalKM" readonly>
      <label>Extra KM</label><input id="extraKM" readonly>
      <label>Toll ‚Çπ</label><input type="number" id="toll" value="0" onchange="recalc()">
      <label>Parking ‚Çπ</label><input type="number" id="parking" value="0" onchange="recalc()">
      <label>Note</label><textarea id="note" rows="3" placeholder="Enter notes..."></textarea>
      <input type="hidden" id="eHr">
      <input type="hidden" id="eKm">
      <input type="hidden" id="freeKm">

      <div class="btn-group">
        <button onclick="shareLast()">üì§ Share</button>
      </div>
    </div>

    <div class="popup" id="tripPopup">
      <h3>üìã Shared Trips</h3>
      <div id="tripList"></div>
      <button onclick="tripPopup.style.display='none'">Close</button>
    </div>

    <div id="printContent"></div>
  </div> <!-- end of protected div -->

  <script>
    const CORRECT_PASS = "nst@123";
    function checkPassword() {
      const entered = document.getElementById('accessPassword').value;
      if (entered === CORRECT_PASS) {
        document.getElementById('loginScreen').style.display = 'none';
        document.getElementById('protected').style.display = 'block';
      } else {
        document.getElementById('loginError').style.display = 'block';
      }
    }

    let tripCounter = 1;
    let sharedTrips = JSON.parse(localStorage.getItem("sharedTrips") || "[]");

    function formatDateInput(dateStr) {
      if (!dateStr) return "";
      const d = new Date(dateStr);
      const dd = String(d.getDate()).padStart(2, '0');
      const mm = String(d.getMonth() + 1).padStart(2, '0');
      const yyyy = d.getFullYear();
      return `${dd}-${mm}-${yyyy}`;
    }

    function to12Hr(timeStr) {
      const [h, m] = timeStr.split(":");
      let hour = parseInt(h);
      let suffix = hour >= 12 ? "PM" : "AM";
      hour = hour % 12 || 12;
      return `${hour}:${m} ${suffix}`;
    }

    function sync(fromModel) {
      const vehicleMap = {
        "Innova Crysta": { no: "PY05N0505" },
        "Innova Hycross": { no: "PY01DB1007" },
        "Force Urbania": { no: "TN14AP2084" }
      };
      if (fromModel) {
        const model = vehicleModel.value;
        if (vehicleMap[model]) vehicleNo.value = vehicleMap[model].no;
      } else {
        const selected = vehicleNo.value;
        for (let m in vehicleMap) {
          if (vehicleMap[m].no === selected) vehicleModel.value = m;
        }
      }
    }

    function syncDriver(fromName) {
      const driverMap = {
        "Perumal": "9699994563",
        "Siva": "9551208961"
      };
      if (fromName) {
        const name = driverName.value;
        if (driverMap[name]) driverNumber.value = driverMap[name];
      } else {
        const num = driverNumber.value;
        for (let n in driverMap) {
          if (driverMap[n] === num) driverName.value = n;
        }
      }
    }

    function recalc() {
      const sTime = startTime.value;
      const eTime = endTime.value;
      if (sTime && eTime) {
        let s = new Date(`1970-01-01T${sTime}`);
        let e = new Date(`1970-01-01T${eTime}`);
        let diff = (e - s) / 3600000;
        if (diff < 0) diff += 24;
        let hrs = Math.ceil(diff);
        duration.value = hrs;
        extraHours.value = hrs > 8 ? hrs - 8 : 0;
      }
      const sKM = parseFloat(startKM.value || 0);
      const eKM = parseFloat(endKM.value || 0);
      const total = eKM - sKM;
      totalKM.value = total;
      extraKM.value = total > 60 ? total - 60 : 0;
    }

    function genTripId() {
      const used = sharedTrips.map(t => t.id);
      for (let i = 1; i <= 999; i++) {
        let id = "#NST" + String(i).padStart(3, '0');
        if (!used.includes(id)) return id;
      }
      return "#NST999";
    }

    function shareLast() {
      const trip = {
        id: genTripId(),
        date: tripDate.value,
        cust: custName.value,
        custNum: custNumber.value,
        driver: driverName.value,
        driverNum: driverNumber.value,
        model: vehicleModel.value,
        no: vehicleNo.value,
        start: startTime.value,
        end: endTime.value,
        duration: duration.value,
        extraHr: extraHours.value,
        totalKM: totalKM.value,
        extraKM: extraKM.value,
        toll: toll.value,
        park: parking.value,
        note: note.value
      };

      const msg = `üìã *TRIP SUMMARY*

*TRIP ID:* ${trip.id}
*DATE:* ${formatDateInput(trip.date)}

üë§ *CUSTOMER INFO*
‚Ä¢ Name: ${trip.cust}
‚Ä¢ Number: ${trip.custNum}

üë®‚Äç‚úà *DRIVER INFO*
‚Ä¢ Name: ${trip.driver}
‚Ä¢ Number: ${trip.driverNum}

üöò *VEHICLE INFO*
‚Ä¢ Model: ${trip.model}
‚Ä¢ Vehicle No: ${trip.no}

üïí *TIME & DISTANCE*
‚Ä¢ Start Time: ${to12Hr(trip.start)}
‚Ä¢ End Time: ${to12Hr(trip.end)}
‚Ä¢ Duration: ${trip.duration} hrs
‚Ä¢ Extra Hrs: ${trip.extraHr}
‚Ä¢ Total KM: ${trip.totalKM} km
‚Ä¢ Extra KM: ${trip.extraKM} km

üõ£ *Toll:* ‚Çπ${trip.toll}
üÖøÔ∏è *Parking:* ‚Çπ${trip.park}

üìù *Note:* ${trip.note || "-"}`;

      const url = "https://wa.me/?text=" + encodeURIComponent(msg);
      const newWindow = window.open(url, "_blank");
      const checker = setInterval(() => {
        if (newWindow.closed) {
          sharedTrips.push(trip);
          localStorage.setItem("sharedTrips", JSON.stringify(sharedTrips));
          clearForm();
          clearInterval(checker);
        }
      }, 1000);
    }

    function clearForm() {
      document.querySelectorAll("#mainForm input, #mainForm select, #mainForm textarea").forEach(el => el.value = '');
      tripId.value = genTripId();
    }

    tripId.value = genTripId();
  </script>
</body>
</html>
