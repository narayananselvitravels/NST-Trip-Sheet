<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>NST Trip Sheet</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.1.6/dist/signature_pad.umd.min.js"></script>
  <style>
    :root {
      --primary: #4b2aad;
      --primary-dark: #371a7e;
      --bg-card: #fff;
    }
    body {
      font-family: 'Poppins', sans-serif;
      background: #f4f6f9;
      margin: 0;
      padding: 20px;
      max-width: 900px;
      margin: auto;
    }
    h2 { color: var(--primary); margin-top: 0; }
    label { font-weight: 600; display: block; margin: 8px 0 4px; }
    input, select, textarea, button {
      width: 100%;
      padding: 10px;
      margin: 4px 0 10px;
      border: 1px solid #ccc;
      border-radius: 6px;
      font-size: 15px;
    }
    button {
      background: var(--primary);
      color: #fff;
      border: none;
      cursor: pointer;
      transition: background 0.3s;
    }
    button:hover { background: var(--primary-dark); }
    .btn-group { display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 10px; }
    .popup {
      display: none;
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.4);
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }
    .popup .content {
      background: var(--bg-card);
      padding: 20px;
      max-width: 800px;
      width: 95%;
      max-height: 90vh;
      border-radius: 8px;
      overflow: auto;
      position: relative;
    }
    .close {
      position: absolute;
      top: 10px; right: 10px;
      background: none;
      border: none;
      font-size: 1.4em;
      cursor: pointer;
      color: #666;
    }
    .trip-card {
      background: #fff;
      border: 1px solid #ccc;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 10px;
    }
    .trip-actions { display: flex; gap: 8px; margin-top: 10px; }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 8px;
      text-align: left;
    }
    th { background: var(--primary); color: #fff; }
    .signature-pad {
      border: 1px solid #ccc;
      height: 120px;
      margin-bottom: 10px;
    }
    .field-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 10px;
    }
    .footer {
      text-align: center;
      color: #555;
      font-style: italic;
      margin-top: 30px;
    }
  </style>
</head>
<body>
  <h2>üìù NST Trip Sheet</h2>
  <div id="mainForm">
    <div class="field-grid">
      <div><label>Trip ID</label><input id="tripId" readonly></div>
      <div><label>Date</label><input type="date" id="tripDate"></div>
      <div><label>Customer Name</label><input id="custName"></div>
      <div><label>Customer Number</label><input id="custNumber"></div>
      <div><label>Driver Name</label><input id="driverName"></div>
      <div><label>Driver Number</label><input id="driverNumber"></div>
      <div><label>Vehicle Model</label>
        <select id="vehicleModel" onchange="sync(true)">
          <option value="">--Select--</option>
          <option>Innova Crysta</option>
          <option>Innova Hycross</option>
          <option>Force Urbania</option>
        </select>
      </div>
      <div><label>Vehicle Number</label>
        <select id="vehicleNo" onchange="sync(false)">
          <option value="">--Select--</option>
          <option>PY05N0505</option>
          <option>PY01DB1007</option>
          <option>TN14AP2084</option>
        </select>
      </div>
      <div><label>Start Time</label><input type="time" id="startTime" onchange="recalc()"></div>
      <div><label>End Time</label><input type="time" id="endTime" onchange="recalc()"></div>
      <div><label>Duration (hrs)</label><input id="duration" readonly></div>
      <div><label>Extra Hours</label><input id="extraHours" readonly></div>
      <div><label>Start KM</label><input type="number" id="startKM" onchange="recalc()"></div>
      <div><label>End KM</label><input type="number" id="endKM" onchange="recalc()"></div>
      <div><label>Total KM</label><input id="totalKM" readonly></div>
      <div><label>Extra KM</label><input id="extraKM" readonly></div>
      <div><label>Package ‚Çπ</label><input id="packageCost" readonly></div>
      <div><label>Extra Hr ‚Çπ</label><input id="extraHrCost" readonly></div>
      <div><label>Extra KM ‚Çπ</label><input id="extraKmCost" readonly></div>
      <div><label>Toll ‚Çπ</label><input type="number" id="toll" value="0" onchange="recalc()"></div>
      <div><label>Parking ‚Çπ</label><input type="number" id="parking" value="0" onchange="recalc()"></div>
      <div><label>Total ‚Çπ</label><input id="totalCost" readonly></div>
      <div style="grid-column:1/-1"><label>Note</label><textarea id="note" rows="3"></textarea></div>
    </div>
    <div class="field-grid">
      <div style="grid-column:1/-1">
        <label>Customer Signature</label>
        <canvas id="custSign" class="signature-pad"></canvas>
        <button onclick="clearSign('custSign')">Clear</button>
      </div>
      <div style="grid-column:1/-1">
        <label>Driver Signature</label>
        <canvas id="driverSign" class="signature-pad"></canvas>
        <button onclick="clearSign('driverSign')">Clear</button>
      </div>
    </div>
    <div class="btn-group">
      <button onclick="saveTrip()">üíæ Save</button>
      <button onclick="showTrips()">üìë View All</button>
      <button onclick="shareLast()">üì§ WhatsApp</button>
      <button onclick="exportPDF()">üìÑ Export PDF</button>
      <button onclick="openDashboard()">üìä Dashboard</button>
      <button onclick="openCalendar()">üìÜ Calendar</button>
      <button onclick="openRates()">‚úèÔ∏è Edit Rates</button>
    </div>
  </div>

  <!-- Popups -->
  <div class="popup" id="tripPopup"><div class="content">
    <button class="close" onclick="tripPopup.style.display='none'">&times;</button>
    <h3>üìã All Trips</h3>
    <input type="text" id="tripSearch" placeholder="üîç Search trips..." oninput="searchTrips()">
    <div id="tripList"></div>
  </div></div>

  <div class="popup" id="ratePopup"><div class="content">
    <button class="close" onclick="ratePopup.style.display='none'">&times;</button>
    <h3>‚úèÔ∏è Edit Vehicle Rates</h3>
    <table><thead><tr>
      <th>Model</th><th>Pkg ‚Çπ</th><th>Hr ‚Çπ</th><th>Km ‚Çπ</th><th>Free Km</th>
    </tr></thead><tbody id="rateRows"></tbody></table>
    <div class="btn-group"><button onclick="saveRates()">Save</button><button onclick="ratePopup.style.display='none'">Cancel</button></div>
  </div></div>

  <div class="popup" id="dashPopup"><div class="content">
    <button class="close" onclick="dashPopup.style.display='none'">&times;</button>
    <h3>üìä Dashboard</h3>
    <canvas id="chartCanvas" height="300"></canvas>
  </div></div>

  <div class="popup" id="calPopup"><div class="content">
    <button class="close" onclick="calPopup.style.display='none'">&times;</button>
    <h3>üìÜ Trip Calendar</h3>
    <div id="calendar"></div>
  </div></div>

  <div id="printContent"></div>
  <div class="footer">üôè Thank you for choosing NST Travels</div>

  <script>
    const RKEY='nst-rates', TKEY='nst-trips';
    let editingId=null;
    let rates=JSON.parse(localStorage.getItem(RKEY))||{
      "Innova Crysta":{pkg:7500,hr:1000,km:20,free:80,no:"PY05N0505"},
      "Innova Hycross":{pkg:8500,hr:1200,km:24,free:60,no:"PY01DB1007"},
      "Force Urbania":{pkg:9500,hr:1500,km:26,free:70,no:"TN14AP2084"}
    };
    const custPad=new SignaturePad(document.getElementById('custSign')),
          driverPad=new SignaturePad(document.getElementById('driverSign'));

    function formatDate(s){if(!s)return'';let d=new Date(s);return`${String(d.getDate()).padStart(2,'0')}-${String(d.getMonth()+1).padStart(2,'0')}-${d.getFullYear()}`;}
    function to12Hr(t){if(!t)return'';let [h,m]=t.split(':'),H=parseInt(h),s=H>=12?"PM":"AM",h12=H%12||12;return`${h12}:${m} ${s}`;}
    function genId(){let a=JSON.parse(localStorage.getItem(TKEY)||'[]');for(let i=1;i<1000;i++){let id='#NST'+String(i).padStart(3,'0');if(!a.find(x=>x.id===id))return id;}return'#NST999';}
    function sync(fromModel){if(fromModel){let m=vehicleModel.value;rates[m]&&(vehicleNo.value=rates[m].no,packageCost.value=rates[m].pkg,eHr.value=rates[m].hr,eKm.value=rates[m].km,freeKm.value=rates[m].free);}else{let no=vehicleNo.value;for(let m in rates)if(rates[m].no===no){vehicleModel.value=m;sync(true);break;}}recalc();}
    function recalc(){if(startTime.value&&endTime.value){let s=new Date(`1970-01-01T${startTime.value}`),e=new Date(`1970-01-01T${endTime.value}`),d=(e-s)/3600000;if(d<0)d+=24;duration.value=Math.ceil(d);extraHours.value=Math.max(0,duration.value-8);}let sk=+startKM.value,ek=+endKM.value,tot=ek-sk;totalKM.value=tot;extraKM.value=Math.max(0,tot-freeKm.value);extraHrCost.value=(+extraHours.value)*eHr.value;extraKmCost.value=(+extraKM.value)*eKm.value;totalCost.value=(+packageCost.value)+(+extraHrCost.value)+(+extraKmCost.value)+(+toll.value)+(+parking.value);}
    function clearSign(id){document.getElementById(id)==document.getElementById(id);if(id==='custSign')custPad.clear();else driverPad.clear();}
    function saveTrip(){let tObj={id:editingId?editingId:tripId.value||genId(),date:tripDate.value,cust:custName
    ...
    // (script continues for showTrips, editTrip, deleteTrip, shareTrip, exportPDF, openDashboard, openCalendar, etc.)
  </script>
</body>
</html>

    // Continue from saveTrip function (expanded fully for clarity)
    function saveTrip(){
      if(!tripDate.value || !custName.value || !driverName.value || !vehicleModel.value){
        alert("Please fill required fields: Date, Customer Name, Driver Name, Vehicle Model.");
        return;
      }
      if(custPad.isEmpty() || driverPad.isEmpty()){
        if(!confirm("One or both signatures are missing. Proceed without signatures?")) return;
      }
      let custSignData = custPad.isEmpty() ? '' : custPad.toDataURL();
      let driverSignData = driverPad.isEmpty() ? '' : driverPad.toDataURL();

      let trip = {
        id: editingId || tripId.value || genId(),
        date: tripDate.value,
        cust: custName.value.trim(),
        custNum: custNumber.value.trim(),
        driver: driverName.value.trim(),
        driverNum: driverNumber.value.trim(),
        model: vehicleModel.value,
        no: vehicleNo.value,
        start: startTime.value,
        end: endTime.value,
        duration: duration.value,
        extraHr: extraHours.value,
        startKM: startKM.value,
        endKM: endKM.value,
        totalKM: totalKM.value,
        extraKM: extraKM.value,
        pkg: packageCost.value,
        hrCost: extraHrCost.value,
        kmCost: extraKmCost.value,
        toll: toll.value,
        park: parking.value,
        total: totalCost.value,
        note: note.value.trim(),
        custSign: custSignData,
        driverSign: driverSignData
      };

      let trips = JSON.parse(localStorage.getItem(TKEY) || '[]');
      if(editingId){
        let idx = trips.findIndex(t => t.id === editingId);
        if(idx !== -1) trips[idx] = trip;
      } else {
        trips.push(trip);
      }
      localStorage.setItem(TKEY, JSON.stringify(trips));
      alert("Trip saved successfully!");
      clearForm();
      editingId = null;
    }

    function clearForm(){
      [...document.querySelectorAll('#mainForm input, #mainForm select, #mainForm textarea')].forEach(el => {
        if(el.id !== 'tripId') el.value = '';
      });
      custPad.clear();
      driverPad.clear();
      tripId.value = genId();
      recalc();
    }

    function showTrips(){
      let trips = JSON.parse(localStorage.getItem(TKEY) || '[]');
      tripList.innerHTML = '';
      if(trips.length === 0){
        tripList.innerHTML = '<p>No trips saved yet.</p>';
        tripPopup.style.display = 'flex';
        return;
      }
      trips.forEach(t=>{
        let div = document.createElement('div');
        div.className = 'trip-card';
        div.innerHTML = `
          <b>${t.id}</b> (${formatDate(t.date)})<br>
          <b>${t.model}</b> - ${t.no}<br>
          ${to12Hr(t.start)} ‚Üí ${to12Hr(t.end)} (${t.duration}h)<br>
          Extra Hr: ${t.extraHr} | Extra KM: ${t.extraKM}<br>
          Toll: ‚Çπ${t.toll} | Parking: ‚Çπ${t.park}<br>
          <b>Total: ‚Çπ${t.total}</b>
          <div class="trip-actions">
            <button onclick="editTrip('${t.id}')">‚úèÔ∏è Edit</button>
            <button onclick="deleteTrip('${t.id}')">‚ùå Delete</button>
            <button onclick="shareTrip('${t.id}')">üì§ Share</button>
          </div>`;
        tripList.appendChild(div);
      });
      tripPopup.style.display = 'flex';
    }

    function searchTrips(){
      let q = tripSearch.value.toLowerCase();
      let trips = JSON.parse(localStorage.getItem(TKEY) || '[]');
      let filtered = trips.filter(t=>{
        return t.id.toLowerCase().includes(q) ||
               (t.cust && t.cust.toLowerCase().includes(q)) ||
               (t.driver && t.driver.toLowerCase().includes(q)) ||
               (t.model && t.model.toLowerCase().includes(q)) ||
               (t.no && t.no.toLowerCase().includes(q));
      });
      tripList.innerHTML = '';
      if(filtered.length === 0){
        tripList.innerHTML = '<p>No matching trips found.</p>';
        return;
      }
      filtered.forEach(t=>{
        let div = document.createElement('div');
        div.className = 'trip-card';
        div.innerHTML = `
          <b>${t.id}</b> (${formatDate(t.date)})<br>
          <b>${t.model}</b> - ${t.no}<br>
          ${to12Hr(t.start)} ‚Üí ${to12Hr(t.end)} (${t.duration}h)<br>
          Extra Hr: ${t.extraHr} | Extra KM: ${t.extraKM}<br>
          Toll: ‚Çπ${t.toll} | Parking: ‚Çπ${t.park}<br>
          <b>Total: ‚Çπ${t.total}</b>
          <div class="trip-actions">
            <button onclick="editTrip('${t.id}')">‚úèÔ∏è Edit</button>
            <button onclick="deleteTrip('${t.id}')">‚ùå Delete</button>
            <button onclick="shareTrip('${t.id}')">üì§ Share</button>
          </div>`;
        tripList.appendChild(div);
      });
    }

    function editTrip(id){
      let trips = JSON.parse(localStorage.getItem(TKEY) || '[]');
      let t = trips.find(x=>x.id===id);
      if(!t) return alert("Trip not found!");
      editingId = t.id;
      tripId.value = t.id;
      tripDate.value = t.date;
      custName.value = t.cust;
      custNumber.value = t.custNum;
      driverName.value = t.driver;
      driverNumber.value = t.driverNum;
      vehicleModel.value = t.model;
      vehicleNo.value = t.no;
      startTime.value = t.start;
      endTime.value = t.end;
      duration.value = t.duration;
      extraHours.value = t.extraHr;
      startKM.value = t.startKM;
      endKM.value = t.endKM;
      totalKM.value = t.totalKM;
      extraKM.value = t.extraKM;
      packageCost.value = t.pkg;
      extraHrCost.value = t.hrCost;
      extraKmCost.value = t.kmCost;
      toll.value = t.toll;
      parking.value = t.park;
      totalCost.value = t.total;
      note.value = t.note;
      if(t.custSign){
        custPad.fromDataURL(t.custSign);
      } else {
        custPad.clear();
      }
      if(t.driverSign){
        driverPad.fromDataURL(t.driverSign);
      } else {
        driverPad.clear();
      }
      tripPopup.style.display = 'none';
    }

    function deleteTrip(id){
      if(!confirm("Are you sure you want to delete this trip?")) return;
      let trips = JSON.parse(localStorage.getItem(TKEY) || '[]');
      trips = trips.filter(t=>t.id!==id);
      localStorage.setItem(TKEY, JSON.stringify(trips));
      showTrips();
    }

    function shareTrip(id){
      let trips = JSON.parse(localStorage.getItem(TKEY) || '[]');
      let t = trips.find(x=>x.id===id);
      if(!t) return alert("Trip not found!");
      let msg=`üìã *TRIP SUMMARY*\n*TRIP ID:* ${t.id}\n*DATE:* ${formatDate(t.date)}\n\n`+
              `üë§ *CUSTOMER INFO*\n‚Ä¢ Name: ${t.cust}\n‚Ä¢ Number: ${t.custNum}\n\n`+
              `üë®‚Äç‚úàÔ∏è *DRIVER INFO*\n‚Ä¢ Name: ${t.driver}\n‚Ä¢ Number: ${t.driverNum}\n\n`+
              `üöò *VEHICLE INFO*\n‚Ä¢ Model: ${t.model}\n‚Ä¢ Vehicle No: ${t.no}\n\n`+
              `üïí *TIME & DISTANCE*\n‚Ä¢ Start Time: ${to12Hr(t.start)}\n‚Ä¢ End Time: ${to12Hr(t.end)}\n`+
              `‚Ä¢ Duration: ${t.duration} hrs\n‚Ä¢ Extra Hrs: ${t.extraHr}\n‚Ä¢ Total KM: ${t.totalKM} km\n‚Ä¢ Extra KM: ${t.extraKM} km\n\n`+
              `üí∞ *BILLING*\n‚Ä¢ Package: ‚Çπ${t.pkg}\n‚Ä¢ Extra Hrs: ‚Çπ${t.hrCost}\n‚Ä¢ Extra KM: ‚Çπ${t.kmCost}\n`+
              `‚Ä¢ Toll: ‚Çπ${t.toll}\n‚Ä¢ Parking: ‚Çπ${t.park}\n‚Ä¢ Total: ‚Çπ${t.total}\n\n`+
              `üìù *Note:* ${t.note||"-"}`;
      window.open("https://wa.me/?text="+encodeURIComponent(msg));
    }

    function shareLast(){
      let trips = JSON.parse(localStorage.getItem(TKEY) || '[]');
      if(trips.length) shareTrip(trips[trips.length-1].id);
      else alert("No trips saved yet!");
    }

    // Rate popup
    function openRates(){
      rateRows.innerHTML = '';
      for(let m in rates){
        let r=rates[m];
        rateRows.innerHTML += `<tr>
          <td>${m}</td>
          <td><input type="number" min="0" value="${r.pkg}" onchange="rates['${m}'].pkg=+this.value"></td>
          <td><input type="number" min="0" value="${r.hr}" onchange="rates['${m}'].hr=+this.value"></td>
          <td><input type="number" min="0" value="${r.km}" onchange="rates['${m}'].km=+this.value"></td>
          <td><input type="number" min="0" value="${r.free}" onchange="rates['${m}'].free=+this.value"></td>
        </tr>`;
      }
      ratePopup.style.display = 'flex';
    }
    function saveRates(){
      localStorage.setItem(RKEY, JSON.stringify(rates));
      ratePopup.style.display = 'none';
      sync(true);
      recalc();
      alert("Rates saved.");
    }

    // Export PDF improved with footer
    function exportPDF(){
      let trips = JSON.parse(localStorage.getItem(TKEY) || '[]');
      if(trips.length === 0){
        alert("No trips to export.");
        return;
      }
      let content = '';
      trips.forEach(t=>{
        content += `
        <div class="invoice" style="border:2px solid #4b2aad; margin-bottom:30px; padding:15px; page-break-after: always;">
          <h2 style="color:#4b2aad; border-bottom:2px solid #4b2aad; padding-bottom:5px; margin-bottom:15px;">NST Travels ‚Äì Trip Invoice</h2>
          <div><strong>Trip ID:</strong> ${t.id}</div>
          <div><strong>Date:</strong> ${formatDate(t.date)}</div>
          <h4>Customer Info</h4>
          <div>Name: ${t.cust} | Number: ${t.custNum}</div>
          <h4>Driver Info</h4>
          <div>Name: ${t.driver} | Number: ${t.driverNum}</div>
          <h4>Vehicle Info</h4>
          <div>Model: ${t.model} | Number: ${t.no}</div>
          <h4>Time & Distance</h4>
          <table style="width:100%; border-collapse:collapse; font-size:16px; margin-top:10px;">
            <thead><tr style="background:#4b2aad; color:#fff;">
              <th>Start</th><th>End</th><th>Duration (hrs)</th><th>Extra Hr</th><th>Total KM</th><th>Extra KM</th>
            </tr></thead>
            <tbody>
              <tr>
                <td>${to12Hr(t.start)}</td><td>${to12Hr(t.end)}</td><td>${t.duration}</td><td>${t.extraHr}</td><td>${t.totalKM}</td><td>${t.extraKM}</td>
              </tr>
            </tbody>
          </table>
          <h4>Billing</h4>
          <table style="width:100%; border-collapse:collapse; font-size:16px; margin-top:10px;">
            <thead><tr style="background:#4b2aad; color:#fff;">
              <th>Package ‚Çπ</th><th>Extra Hr ‚Çπ</th><th>Extra KM ‚Çπ</th><th>Toll ‚Çπ</th><th>Parking ‚Çπ</th><th>Total ‚Çπ</th>
            </tr></thead>
            <tbody>
              <tr>
                <td>‚Çπ${t.pkg}</td><td>‚Çπ${t.hrCost}</td><td>‚Çπ${t.kmCost}</td><td>‚Çπ${t.toll}</td><td>‚Çπ${t.park}</td><td><strong>‚Çπ${t.total}</strong></td>
              </tr>
            </tbody>
          </table>
          <h4>Note</h4>
          <div>${t.note || "-"}</div>
          <div style="margin-top:20px; font-style: italic; text-align:center; color:#666;">üôè Thank you for choosing NST Travels</div>
        </div>`;
      });
      let w=window.open('','_blank','width=900,height=700');
      w.document.write(`
        <html><head><title>NST Trip Invoices</title>
        <style>
          body{font-family:'Poppins', sans-serif; background:#fff; color:#000; padding:20px;}
          h2,h4{color:#4b2aad; margin-bottom:5px;}
          table, th, td{border:1px solid #4b2aad; border-collapse:collapse; padding:8px;}
          th{background:#4b2aad; color:#fff;}
          .invoice{page-break-after:always;}
        </style>
        </head><body>${content}</body></html>`);
      w.document.close();
      w.focus();
      w.print();
    }

    // Dashboard Chart
    let chart = null;
    function openDashboard(){
      dashPopup.style.display = 'flex';
      let trips = JSON.parse(localStorage.getItem(TKEY) || '[]');
      if(!chart){
        let ctx = document.getElementById('chartCanvas').getContext('2d');
        chart = new Chart(ctx, {
          type: 'bar',
          data: {labels:[], datasets:[
            {label:'Total ‚Çπ', backgroundColor: '#4b2aad', data:[]},
            {label:'Extra Hr ‚Çπ', backgroundColor:'#7b59d9', data:[]},
            {label:'Extra KM ‚Çπ', backgroundColor:'#a085e5', data:[]}
          ]},
          options: {
            responsive:true,
            scales:{y:{beginAtZero:true}},
            plugins:{legend:{position:'top'}}
          }
        });
      }
      let labels = trips.map(t => t.id);
      let totalData = trips.map(t => +t.total);
      let extraHrData = trips.map(t => +t.hrCost);
      let extraKmData
