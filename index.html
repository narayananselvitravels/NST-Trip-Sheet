<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>NST Trip Sheet</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { font-family: 'Segoe UI', sans-serif; background: #f5f5f5; margin: 0; padding: 20px; max-width: 800px; margin: auto; }
    label { font-weight: bold; display: block; margin-top: 10px; }
    input, select, button, textarea {
      width: 100%; padding: 10px; font-size: 16px; margin-top: 5px;
      border-radius: 5px; border: 1px solid #ccc;
    }
    button { background: #4b2aad; color: white; border: none; margin-top: 15px; cursor: pointer; }
    button:hover { background: #3a1d91; }
    .btn-group { display: flex; gap: 10px; flex-wrap: wrap; }
    .popup {
      display: none; position: fixed; top: 10%; left: 5%; width: 90%;
      background: white; padding: 20px; border-radius: 10px;
      box-shadow: 0 0 10px rgba(0,0,0,0.3); z-index: 9999;
    }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 15px; }
    th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
    th { background: #4b2aad; color: white; }
  </style>
</head>
<body>

<h2>üìù NST Trip Sheet</h2>

<label>Vehicle Model</label>
<select id="vehicleModel" onchange="sync(true)">
  <option value="">-- Select --</option>
  <option>Innova Crysta</option>
  <option>Innova Hycross</option>
  <option>Force Urbania</option>
</select>

<label>Vehicle Number</label>
<select id="vehicleNo" onchange="sync(false)">
  <option value="">-- Select --</option>
  <option>PY05N0505</option>
  <option>PY01DB1007</option>
  <option>TN14AP2084</option>
</select>

<label>Start Time</label>
<input type="time" id="startTime" onchange="recalc()">

<label>End Time</label>
<input type="time" id="endTime" onchange="recalc()">

<label>Start KM</label>
<input type="number" id="startKM" onchange="recalc()">

<label>End KM</label>
<input type="number" id="endKM" onchange="recalc()">

<label>Duration (hrs)</label>
<input id="duration" readonly>

<label>Extra Hours</label>
<input id="extraHours" readonly>

<label>Total KM</label>
<input id="totalKM" readonly>

<label>Extra KM</label>
<input id="extraKM" readonly>

<input type="hidden" id="freeKm">
<input type="hidden" id="freeHr">

<div class="btn-group">
  <button onclick="openEditPackagePopup()">‚úèÔ∏è Edit Package</button>
</div>

<!-- Edit Package Popup -->
<div class="popup" id="editPackagePopup">
  <h3>‚úèÔ∏è Edit Package Limits</h3>
  <table>
    <thead><tr><th>Model</th><th>Free KM</th><th>Free Hr</th></tr></thead>
    <tbody id="editPackageTable"></tbody>
  </table>
  <button onclick="savePackageLimits()">Save</button>
  <button onclick="document.getElementById('editPackagePopup').style.display='none'">Cancel</button>
</div>

<script>
const vehicleModel = document.getElementById("vehicleModel");
const vehicleNo = document.getElementById("vehicleNo");
const freeKm = document.getElementById("freeKm");
const freeHr = document.getElementById("freeHr");

let rates = {
  "Innova Crysta": { no: "PY05N0505" },
  "Innova Hycross": { no: "PY01DB1007" },
  "Force Urbania": { no: "TN14AP2084" }
};

// Model-specific package limits (free KM and hours)
let pricing = {
  "Innova Crysta": { freeKm: 80, freeHr: 8 },
  "Innova Hycross": { freeKm: 90, freeHr: 6 },
  "Force Urbania": { freeKm: 70, freeHr: 7 }
};

// Load from localStorage if exists
const savedPricing = localStorage.getItem("nst-pricing");
if (savedPricing) pricing = JSON.parse(savedPricing);

function sync(fromModel) {
  if (fromModel) {
    const model = vehicleModel.value;
    if (rates[model]) {
      vehicleNo.value = rates[model].no;
      freeKm.value = pricing[model]?.freeKm || 0;
      freeHr.value = pricing[model]?.freeHr || 0;
    }
  } else {
    const no = vehicleNo.value;
    for (let model in rates) {
      if (rates[model].no === no) {
        vehicleModel.value = model;
        sync(true);
        break;
      }
    }
  }
  recalc();
}

function recalc() {
  const startTime = document.getElementById("startTime").value;
  const endTime = document.getElementById("endTime").value;
  const startKM = +document.getElementById("startKM").value;
  const endKM = +document.getElementById("endKM").value;
  const freeHrVal = +freeHr.value || 0;
  const freeKmVal = +freeKm.value || 0;

  if (startTime && endTime) {
    let s = new Date(`1970-01-01T${startTime}`);
    let e = new Date(`1970-01-01T${endTime}`);
    let diff = (e - s) / 3600000;
    if (diff < 0) diff += 24;
    const hrs = Math.ceil(diff);
    document.getElementById("duration").value = hrs;
    document.getElementById("extraHours").value = hrs > freeHrVal ? hrs - freeHrVal : 0;
  }

  const totalKM = endKM - startKM;
  document.getElementById("totalKM").value = totalKM;
  document.getElementById("extraKM").value = totalKM > freeKmVal ? totalKM - freeKmVal : 0;
}

function openEditPackagePopup() {
  const tbody = document.getElementById("editPackageTable");
  tbody.innerHTML = '';
  for (let model in pricing) {
    const p = pricing[model];
    tbody.innerHTML += `
      <tr>
        <td>${model}</td>
        <td><input type="number" value="${p.freeKm}" onchange="pricing['${model}'].freeKm=this.value"></td>
        <td><input type="number" value="${p.freeHr}" onchange="pricing['${model}'].freeHr=this.value"></td>
      </tr>
    `;
  }
  document.getElementById("editPackagePopup").style.display = 'block';
}

function savePackageLimits() {
  localStorage.setItem("nst-pricing", JSON.stringify(pricing));
  document.getElementById("editPackagePopup").style.display = 'none';
  sync(true);
}
</script>

</body>
</html>
