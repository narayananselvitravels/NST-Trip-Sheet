<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>NST Trip Sheet</title>
  <style>
    body { font-family: 'Segoe UI', sans-serif; margin: 0 auto; padding: 15px; max-width: 800px; background: #f9f9f9; }
    h2 { color: #4b2aad; margin-bottom: 10px; }
    label { display: block; margin-top: 10px; font-weight: bold; }
    input, select, textarea, button {
      width: 100%; padding: 8px; font-size: 16px; margin-top: 5px; margin-bottom: 12px; border: 1px solid #ccc; border-radius: 5px;
    }
    textarea { resize: vertical; }
    button { background: #4b2aad; color: white; border: none; cursor: pointer; }
    button:hover { background: #3c2193; }
    .btn-group { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 10px; }
    .ratePopup {
      display: none; position: fixed; top: 5%; left: 50%; transform: translateX(-50%);
      width: 95%; max-width: 600px; background: white; padding: 20px; border-radius: 10px;
      box-shadow: 0 0 10px rgba(0,0,0,0.3); z-index: 1000;
    }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 15px; }
    th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
    th { background: #4b2aad; color: white; }
    @media (max-width: 600px) {
      input, select, textarea, button { font-size: 15px; }
    }
  </style>
</head>
<body>
  <h2>üìù NST Trip Sheet</h2>
  <div id="mainForm">
    <label>Trip ID</label><input id="tripId" readonly>
    <label>Date</label><input type="date" id="tripDate">
    <label>Customer Name</label><input id="custName">
    <label>Customer Number</label><input id="custNumber">
    <label>Driver Name</label>
    <select id="driverName" onchange="syncDriver(true)">
      <option value="">-- Select --</option>
      <option value="Perumal">Perumal</option>
      <option value="Siva">Siva</option>
    </select>
    <label>Driver Number</label>
    <select id="driverNumber" onchange="syncDriver(false)">
      <option value="">-- Select --</option>
      <option value="9699994563">9699994563</option>
      <option value="9551208961">9551208961</option>
    </select>
    <label>Vehicle Model</label>
    <select id="vehicleModel" onchange="sync(true)">
      <option value="">-- Select --</option>
      <option>Innova Crysta</option>
      <option>Innova Hycross</option>
      <option>Force Urbania</option>
    </select>
    <label>Vehicle Number</label>
    <select id="vehicleNo" onchange="sync(false)">
      <option value="">-- Select --</option>
      <option>PY05N0505</option>
      <option>PY01DB1007</option>
      <option>TN14AP2084</option>
    </select>
    <label>Start Time</label><input type="time" id="startTime" onchange="recalc()">
    <label>End Time</label><input type="time" id="endTime" onchange="recalc()">
    <label>Duration (hrs)</label><input id="duration" readonly>
    <label>Extra Hours</label><input id="extraHours" readonly>
    <label>Start KM</label><input type="number" id="startKM" onchange="recalc()">
    <label>End KM</label><input type="number" id="endKM" onchange="recalc()">
    <label>Total KM</label><input id="totalKM" readonly>
    <label>Extra KM</label><input id="extraKM" readonly>
    <label>Toll ‚Çπ</label><input type="number" id="toll" value="0" onchange="recalc()">
    <label>Parking ‚Çπ</label><input type="number" id="parking" value="0" onchange="recalc()">
    <label>Note</label><textarea id="note" rows="3" placeholder="Enter notes..."></textarea>

    <div class="btn-group">
      <button onclick="shareLast()">üì§ Share via WhatsApp</button>
      <button onclick="openRates()">‚úèÔ∏è Edit Rates</button>
    </div>
  </div>

  <div class="ratePopup" id="ratePopup">
    <h3>‚úèÔ∏è Edit Free KM & Package Hours</h3>
    <table>
      <thead>
        <tr><th>Model</th><th>Free KM</th><th>Package Hours</th></tr>
      </thead>
      <tbody id="rateRows"></tbody>
    </table>
    <button onclick="saveRates()">üíæ Save</button>
    <button onclick="ratePopup.style.display='none'">‚ùå Cancel</button>
  </div>

<script>
let RKEY = 'nst-rates';
let rates = JSON.parse(localStorage.getItem(RKEY)) || {
  "Innova Crysta": { free: 80, hours: 8, no: "PY05N0505" },
  "Innova Hycross": { free: 60, hours: 10, no: "PY01DB1007" },
  "Force Urbania": { free: 70, hours: 12, no: "TN14AP2084" }
};

let tripCount = parseInt(localStorage.getItem('tripCounter') || '0');

function genId() {
  return "#NST" + String(tripCount + 1).padStart(3, '0');
}

function to12Hr(timeStr) {
  if (!timeStr) return "";
  const [h, m] = timeStr.split(":");
  let hour = parseInt(h);
  let suffix = hour >= 12 ? "PM" : "AM";
  hour = hour % 12 || 12;
  return `${hour}:${m} ${suffix}`;
}

function formatDate(d) {
  const date = new Date(d);
  const dd = String(date.getDate()).padStart(2, '0');
  const mm = String(date.getMonth() + 1).padStart(2, '0');
  const yyyy = date.getFullYear();
  return `${dd}-${mm}-${yyyy}`;
}

function sync(fromModel) {
  if (fromModel) {
    const model = vehicleModel.value;
    const r = rates[model];
    if (r) {
      vehicleNo.value = r.no;
      freeKm = r.free;
      recalc();
    }
  } else {
    const no = vehicleNo.value;
    for (let m in rates) {
      if (rates[m].no === no) {
        vehicleModel.value = m;
        sync(true);
        break;
      }
    }
  }
}

function syncDriver(fromName) {
  if (fromName) {
    const name = driverName.value;
    driverNumber.value = name === 'Perumal' ? '9699994563' : (name === 'Siva' ? '9551208961' : '');
  } else {
    const num = driverNumber.value;
    driverName.value = num === '9699994563' ? 'Perumal' : (num === '9551208961' ? 'Siva' : '');
  }
}

function recalc() {
  let s = new Date(`1970-01-01T${startTime.value}`);
  let e = new Date(`1970-01-01T${endTime.value}`);
  let hrs = 0;
  if (startTime.value && endTime.value) {
    let diff = (e - s) / 3600000;
    if (diff < 0) diff += 24;
    hrs = Math.ceil(diff);
    duration.value = hrs;
  }

  const model = vehicleModel.value;
  const pkgHours = (rates[model]?.hours) || 8;
  extraHours.value = hrs > pkgHours ? hrs - pkgHours : 0;

  const start = parseFloat(startKM.value) || 0;
  const end = parseFloat(endKM.value) || 0;
  const total = end - start;
  totalKM.value = total;
  const free = parseInt(rates[model]?.free) || 0;
  extraKM.value = total > free ? total - free : 0;
}

function openRates() {
  rateRows.innerHTML = '';
  for (let m in rates) {
    let r = rates[m];
    if (!r.hours) r.hours = 8;
    rateRows.innerHTML += `
      <tr>
        <td>${m}</td>
        <td><input type="number" value="${r.free}" onchange="rates['${m}'].free=this.value"></td>
        <td><input type="number" value="${r.hours}" onchange="rates['${m}'].hours=this.value"></td>
      </tr>`;
  }
  ratePopup.style.display = 'block';
}

function saveRates() {
  localStorage.setItem(RKEY, JSON.stringify(rates));
  ratePopup.style.display = 'none';
  sync(true);
}

function shareLast() {
  const id = genId();
  const msg = `
üìã *TRIP SUMMARY*

*TRIP ID:* ${id}
*DATE:* ${formatDate(tripDate.value)}

üë§ *CUSTOMER INFO*
‚Ä¢ *Name:* ${custName.value}
‚Ä¢ *Number:* ${custNumber.value}

üë®‚Äç‚úà *DRIVER INFO*
‚Ä¢ *Name:* ${driverName.value}
‚Ä¢ *Number:* ${driverNumber.value}

üöò *VEHICLE INFO*
‚Ä¢ *Model:* ${vehicleModel.value}
‚Ä¢ *Vehicle No:* ${vehicleNo.value}

üïí *TIME & DISTANCE*
‚Ä¢ *Start Time:* ${to12Hr(startTime.value)}
‚Ä¢ *End Time:* ${to12Hr(endTime.value)}
‚Ä¢ *Duration:* ${duration.value || 0} hrs
‚Ä¢ *Extra Hrs:* ${extraHours.value || 0}
‚Ä¢ *Total KM:* ${totalKM.value || 0} km
‚Ä¢ *Extra KM:* ${extraKM.value || 0} km

üßæ *OTHER CHARGES*
‚Ä¢ *Parking:* ‚Çπ${parking.value || 0}
‚Ä¢ *Toll:* ‚Çπ${toll.value || 0}

üìù *Note:* ${note.value || '-'}`.trim();

  const win = window.open("https://wa.me/?text=" + encodeURIComponent(msg), "_blank");

  // Wait 3 seconds, then assume success and increment trip counter
  setTimeout(() => {
    tripCount++;
    localStorage.setItem('tripCounter', tripCount);
    tripId.value = genId();
  }, 3000);
}

window.onload = () => {
  tripId.value = genId();
};
</script>
</body>
</html>