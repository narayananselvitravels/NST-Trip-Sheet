<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>NST Trip Sheet</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet" />
  <style>
    body { font-family:'Poppins',sans-serif; background:#f4f6f9; margin:0 auto; max-width:800px; padding:20px }
    h2 { color:#4b2aad }
    label { font-weight:600; margin-top:10px; display:block }
    input, select, textarea {
      width:100%; padding:10px; margin:5px 0 15px;
      border:1px solid #ccc; border-radius:5px; font-size:16px
    }
    button {
      background:#4b2aad; color:#fff; border:none;
      padding:12px 20px; border-radius:5px; font-size:16px; cursor:pointer;
      margin-right:10px
    }
    button:hover { background:#3a208b }
    table { width:100%; border-collapse:collapse; margin-top:20px }
    th, td { padding:8px; border:1px solid #ddd; text-align:left }
    th { background:#4b2aad; color:#fff }
    .form-group { position:relative }
    .autocomplete-list {
      position:absolute; top:100%; left:0; right:0;
      background:#fff; border:1px solid #ccc; z-index:10;
      max-height:200px; overflow-y:auto
    }
    .autocomplete-list div {
      padding:8px; cursor:pointer
    }
    .autocomplete-list div:hover { background:#f0f0f0 }
  </style>
</head>
<body>

<h2>ğŸ“ NST Trip Sheet</h2>

<label>Trip ID</label>
<input id="tripId" readonly>

<label>Date</label>
<input type="date" id="tripDate">

<label>Pickup Location</label>
<div class="form-group">
  <input id="pickup" placeholder="Enter pickup location" autocomplete="off" />
</div>

<label>Drop Location</label>
<div class="form-group">
  <input id="drop" placeholder="Enter drop location" autocomplete="off" />
</div>

<label>Customer Name</label><input id="custName">
<label>Customer Number</label><input id="custNumber">

<label>Driver Name</label>
<select id="driverName" onchange="syncDriver(true)"></select>

<label>Driver Number</label>
<select id="driverNumber" onchange="syncDriver(false)"></select>

<label>Vehicle Model</label>
<select id="vehicleModel" onchange="syncVehicle(true)"></select>

<label>Vehicle Number</label>
<select id="vehicleNo" onchange="syncVehicle(false)"></select>

<label>Start Time</label><input type="time" id="startTime">
<label>End Time</label><input type="time" id="endTime">

<label>Extra Hours (Manual)</label><input id="extraHours" type="number">
<label>Extra KM (Manual)</label><input id="extraKM" type="number">

<label>Parking â‚¹</label><input id="parking" type="number" value="0">
<label>Toll â‚¹</label><input id="toll" type="number" value="0">
<label>Total Amount â‚¹</label><input id="totalAmount" type="number">

<label>Payment Status</label>
<select id="paymentStatus">
  <option value="">-- Select --</option>
  <option value="Paid">Paid</option>
  <option value="Not Paid">Not Paid</option>
</select>

<label>Note</label><textarea id="note" rows="3" placeholder="Enter any trip notes..."></textarea>

<div style="margin-top:15px">
  <button onclick="shareWhatsApp()">ğŸ“¤ Share via WhatsApp</button>
  <button onclick="showSharedTrips()">ğŸ“‹ View Shared Trips</button>
  <button onclick="exportSharedTrips()">ğŸ“¥ Export (Excel)</button>
  <button onclick="document.getElementById('adminLogin').style.display='block'" style="background:#6c757d">ğŸ” Admin Panel</button>
</div>

<div id="sharedTripsList"></div>

<!-- Admin login modal -->
<div id="adminLogin" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:9999">
  <div style="background:white;max-width:300px;margin:100px auto;padding:20px;border-radius:10px">
    <h3 style="margin-top:0">ğŸ” Admin Login</h3>
    <label>Username</label><input type="text" id="adminUser" placeholder="Username">
    <label>Password</label><input type="password" id="adminPass" placeholder="Password">
    <button onclick="loginAdmin()">Login</button>
    <button onclick="document.getElementById('adminLogin').style.display='none'" style="background:#dc3545;margin-top:10px">Cancel</button>
  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script><script>
// Trip ID
function genTripId() {
  let seq = parseInt(localStorage.getItem("trip-seq") || "1");
  return "#NST" + String(seq).padStart(3, "0");
}
function reserveNextId() {
  let c = parseInt(localStorage.getItem("trip-seq") || "1");
  localStorage.setItem("trip-seq", c + 1);
  tripId.value = genTripId();
}

// Load master data
let drivers = JSON.parse(localStorage.getItem("drivers") || "[]");
let vehicles = JSON.parse(localStorage.getItem("vehicles") || "[]");

function populateDropdown(id, list, key) {
  const sel = document.getElementById(id);
  sel.innerHTML = '<option value="">-- Select --</option>';
  list.forEach(d => sel.innerHTML += `<option value="${d[key]}">${d[key]}</option>`);
}

function syncDriver(fromName) {
  if (fromName) {
    const name = driverName.value;
    const match = drivers.find(d => d.name === name);
    driverNumber.value = match ? match.number : "";
  } else {
    const number = driverNumber.value;
    const match = drivers.find(d => d.number === number);
    driverName.value = match ? match.name : "";
  }
}

function syncVehicle(fromModel) {
  if (fromModel) {
    const model = vehicleModel.value;
    const match = vehicles.find(v => v.model === model);
    vehicleNo.value = match ? match.number : "";
  } else {
    const number = vehicleNo.value;
    const match = vehicles.find(v => v.number === number);
    vehicleModel.value = match ? match.model : "";
  }
}

function to12Hr(t) {
  if (!t) return "";
  const [h, m] = t.split(":"), d = new Date();
  d.setHours(h, m);
  return d.toLocaleTimeString('en-IN', { hour: '2-digit', minute: '2-digit', hour12: true });
}

function shareWhatsApp() {
  const data = {
    id: tripId.value,
    date: tripDate.value,
    pickup: pickup.value,
    drop: drop.value,
    custName: custName.value, custNo: custNumber.value,
    driverName: driverName.value, driverNo: driverNumber.value,
    model: vehicleModel.value, vehicleNo: vehicleNo.value,
    start: startTime.value, end: endTime.value,
    extraH: extraHours.value, extraKM: extraKM.value,
    parking: parking.value, toll: toll.value,
    totalAmount: totalAmount.value,
    paid: paymentStatus.value, note: note.value
  };

  const msg = `ğŸ“‹ *TRIP SUMMARY*\n\n*Trip ID:* ${data.id}\n*Date:* ${data.date}\n\n` +
    `ğŸ“ *Pickup:* ${data.pickup}\nğŸ“ *Drop:* ${data.drop}\n\n` +
    `ğŸ‘¤ *Customer:* ${data.custName} (${data.custNo})\n` +
    `ğŸ‘¨â€âœˆï¸ *Driver:* ${data.driverName} (${data.driverNo})\n` +
    `ğŸš˜ *Vehicle:* ${data.model} (${data.vehicleNo})\n\n` +
    `ğŸ•’ *Time:* ${to12Hr(data.start)} â€“ ${to12Hr(data.end)}\n` +
    `ğŸ• *Extra Hrs:* ${data.extraH}\nğŸ“ *Extra KM:* ${data.extraKM}\n\n` +
    `ğŸ’° *Charges:*\nâ€¢ Parking: â‚¹${data.parking}\nâ€¢ Toll: â‚¹${data.toll}\nâ€¢ Total: â‚¹${data.totalAmount}\nâ€¢ Payment: ${data.paid}\n\nğŸ“ ${data.note || "-"}`;

  window.open("https://wa.me/?text=" + encodeURIComponent(msg), '_blank');

  let arr = JSON.parse(localStorage.getItem("shared-trips") || "[]");
  arr.push(data);
  localStorage.setItem("shared-trips", JSON.stringify(arr));
  reserveNextId();
}

function showSharedTrips() {
  let arr = JSON.parse(localStorage.getItem("shared-trips") || "[]");
  let out = `<h3>ğŸ“‹ Shared Trips</h3><table><tr><th>ID</th><th>Date</th><th>Pickup</th><th>Drop</th><th>Driver</th><th>Vehicle</th><th>Total â‚¹</th><th>Paid</th></tr>`;
  arr.forEach(r => {
    out += `<tr><td>${r.id}</td><td>${r.date}</td><td>${r.pickup}</td><td>${r.drop}</td><td>${r.driverName}</td><td>${r.vehicleNo}</td><td>${r.totalAmount}</td><td>${r.paid}</td></tr>`;
  });
  sharedTripsList.innerHTML = out + "</table>";
}

function exportSharedTrips() {
  let data = JSON.parse(localStorage.getItem("shared-trips") || "[]");
  if (!data.length) return alert("No trips to export.");
  const ws = XLSX.utils.json_to_sheet(data);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "NST_Trips");
  XLSX.writeFile(wb, "NST_Trips.xlsx");
}

function loginAdmin() {
  const user = adminUser.value.trim(), pass = adminPass.value.trim();
  if (user === "admin" && pass === "1234") {
    window.location.href = "admin.html";
  } else alert("âŒ Invalid credentials");
}

// Autocomplete for pickup/drop using OpenStreetMap (Nominatim)
function attachAutocomplete(id) {
  const input = document.getElementById(id);
  const wrap = document.createElement("div");
  wrap.classList.add("autocomplete-list");
  input.parentNode.appendChild(wrap);
  input.addEventListener("input", async () => {
    const q = input.value.trim();
    if (q.length < 2) return wrap.innerHTML = "";
    const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${q}`);
    const data = await res.json();
    wrap.innerHTML = data.map(item => `<div>${item.display_name}</div>`).join("");
    [...wrap.children].forEach(child => {
      child.onclick = () => {
        input.value = child.textContent;
        wrap.innerHTML = "";
      }
    });
  });
}

attachAutocomplete("pickup");
attachAutocomplete("drop");

// Init
tripId.value = genTripId();
populateDropdown("driverName", drivers, "name");
populateDropdown("driverNumber", drivers, "number");
populateDropdown("vehicleModel", vehicles, "model");
populateDropdown("vehicleNo", vehicles, "number");
</script>