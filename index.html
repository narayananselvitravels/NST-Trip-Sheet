<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>NST Trip Sheet</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <style>
    body { font-family:'Poppins',sans-serif;margin:0 auto;padding:20px;max-width:800px;background:#f4f6f9 }
    h2 { color:#4b2aad }
    label { font-weight:bold;margin-top:10px;display:block }
    input, select, textarea, button { width:100%;padding:10px;margin:5px 0 15px;border:1px solid #ccc;border-radius:5px;font-size:16px }
    button { background:#4b2aad;color:#fff;border:none;cursor:pointer }
    button:hover { background:#3a208b }
  </style>
</head>
<body>

<h2>üìù NST Trip Sheet</h2>

<label>Trip ID</label>
<input id="tripId" readonly>

<label>Date</label>
<div style="position:relative">
  <input type="text" id="tripDateDisplay" placeholder="Select Date" readonly style="cursor:pointer">
  <input type="date" id="tripDate" style="opacity:0;position:absolute;top:0;left:0;width:100%;height:100%;cursor:pointer">
</div>

<label>Customer Name</label><input id="custName">
<label>Customer Number</label><input id="custNumber">

<label>Driver Name</label><select id="driverName">
  <option value="">-- Select --</option>
  <option>Perumal</option>
  <option>Siva</option>
</select>

<label>Driver Number</label><select id="driverNumber">
  <option value="">-- Select --</option>
  <option>9699994563</option>
  <option>9551208961</option>
</select>

<label>Vehicle Model</label><select id="vehicleModel" onchange="recalc()">
  <option value="">-- Select --</option>
  <option>Innova Crysta</option>
  <option>Innova Hycross</option>
  <option>Force Urbania</option>
</select>

<label>Vehicle Number</label><select id="vehicleNo">
  <option value="">-- Select --</option>
  <option>PY05N0505</option>
  <option>PY01DB1007</option>
  <option>TN14AP2084</option>
</select>

<label>Start Time</label><input type="time" id="startTime" onchange="recalc()">
<label>End Time</label><input type="time" id="endTime" onchange="recalc()">
<label>Duration (hrs)</label><input id="duration" readonly>
<label>Extra Hours</label><input id="extraHours" readonly>
<label>Start KM</label><input type="number" id="startKM" onchange="recalc()">
<label>End KM</label><input type="number" id="endKM" onchange="recalc()">
<label>Total KM</label><input id="totalKM" readonly>
<label>Extra KM</label><input id="extraKM" readonly>

<label>Parking ‚Çπ</label><input type="number" id="parking" value="0">
<label>Toll ‚Çπ</label><input type="number" id="toll" value="0">

<label>Note</label><textarea id="note" rows="3" placeholder="Enter any trip notes..."></textarea>

<div style="margin-top:15px">
  <button onclick="shareWhatsApp()">üì§ Share via WhatsApp</button>
</div>

<script>
const SHKEY = "shared-trips";

// Vehicle model limits
const modelLimits = {
  "Innova Crysta": { freeKM: 80, freeHours: 8 },
  "Innova Hycross": { freeKM: 90, freeHours: 6 },
  "Force Urbania": { freeKM: 70, freeHours: 7 }
};

function genId() {
  let n = parseInt(localStorage.getItem("trip-seq") || "1");
  return "#NST" + String(n).padStart(3, "0");
}
function reserveNextId() {
  let c = parseInt(localStorage.getItem("trip-seq") || "1");
  localStorage.setItem("#NST" + String(c).padStart(3, "0"), "used");
  localStorage.setItem("trip-seq", c + 1);
  tripId.value = genId();
}
function formatDate(raw) {
  const d = new Date(raw);
  return `${String(d.getDate()).padStart(2, "0")}-${String(d.getMonth() + 1).padStart(2, "0")}-${d.getFullYear()}`;
}
function to12Hr(t) {
  if (!t) return "";
  const [h, m] = t.split(":");
  let d = new Date();
  d.setHours(h, m);
  return d.toLocaleTimeString('en-IN', { hour: '2-digit', minute: '2-digit', hour12: true, timeZone: 'Asia/Kolkata' });
}

function recalc() {
  const model = vehicleModel.value;
  const limits = modelLimits[model] || { freeKM: 0, freeHours: 0 };

  if (startTime.value && endTime.value) {
    let s = new Date(`1970-01-01T${startTime.value}`);
    let e = new Date(`1970-01-01T${endTime.value}`);
    let diff = (e - s) / 3600000;
    if (diff < 0) diff += 24;
    const dur = Math.ceil(diff);
    duration.value = dur;
    extraHours.value = dur > limits.freeHours ? dur - limits.freeHours : 0;
  }

  const kmStart = +startKM.value;
  const kmEnd = +endKM.value;
  const total = kmEnd - kmStart;
  totalKM.value = total;
  extraKM.value = total > limits.freeKM ? total - limits.freeKM : 0;
}

function shareWhatsApp() {
  const rawDate = tripDateDisplay.dataset.raw;
  if (!rawDate) return alert("Select date first.");

  const data = {
    id: tripId.value,
    date: rawDate,
    custName: custName.value,
    custNo: custNumber.value,
    driverName: driverName.value,
    driverNo: driverNumber.value,
    model: vehicleModel.value,
    vehicleNo: vehicleNo.value,
    start: startTime.value,
    end: endTime.value,
    duration: duration.value,
    extraH: extraHours.value,
    totalKM: totalKM.value,
    extraKM: extraKM.value,
    parking: parking.value,
    toll: toll.value,
    note: note.value
  };

  const msg = `üìã *TRIP SUMMARY*\n\n*TRIP ID:* ${data.id}\n*DATE:* ${formatDate(data.date)}\n\n` +
    `üë§ *CUSTOMER INFO*\n‚Ä¢ *Name:* ${data.custName}\n‚Ä¢ *Number:* ${data.custNo}\n\n` +
    `üë®‚Äç‚úàÔ∏è *DRIVER INFO*\n‚Ä¢ *Name:* ${data.driverName}\n‚Ä¢ *Number:* ${data.driverNo}\n\n` +
    `üöò *VEHICLE INFO*\n‚Ä¢ *Model:* ${data.model}\n‚Ä¢ *Vehicle No:* ${data.vehicleNo}\n\n` +
    `üïí *TIME & DISTANCE*\n‚Ä¢ *Start Time:* ${to12Hr(data.start)}\n‚Ä¢ *End Time:* ${to12Hr(data.end)}\n` +
    `‚Ä¢ *Duration:* ${data.duration} hrs\n‚Ä¢ *Extra Hrs:* ${data.extraH}\n‚Ä¢ *Total KM:* ${data.totalKM} km\n‚Ä¢ *Extra KM:* ${data.extraKM} km\n\n` +
    `üí∞ *CHARGES*\n‚Ä¢ *Parking:* ‚Çπ${data.parking}\n‚Ä¢ *Toll:* ‚Çπ${data.toll}\n\n` +
    `üìù *Note:* ${data.note || "-"}`;

  window.open("https://wa.me/?text=" + encodeURIComponent(msg), '_blank');
  reserveNextId();
}

tripDate.addEventListener("change", () => {
  const raw = tripDate.value, d = new Date(raw);
  tripDateDisplay.value = d.toLocaleDateString("en-GB", { day: '2-digit', month: 'long', year: 'numeric', timeZone: 'Asia/Kolkata' });
  tripDateDisplay.dataset.raw = raw;
});

tripId.value = genId();
</script>

</body>
</html>