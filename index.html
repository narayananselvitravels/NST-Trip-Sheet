<body>
<h2>ğŸ“ NST Trip Sheet</h2>
<div id="mainForm">
  <label>Language</label>
  <select id="lang" onchange="switchLang()">
    <option value="en">English</option>
    <option value="ta">à®¤à®®à®¿à®´à¯</option>
    <option value="hi">à¤¹à¤¿à¤‚à¤¦à¥€</option>
  </select>

  <label>Trip ID</label><input id="tripId" readonly>
  <label>Date</label><input type="date" id="tripDate">
  <label>Customer Name</label><input id="custName">
  <label>Customer Number</label><input id="custNumber">
  <label>Driver Name</label><input id="driverName">
  <label>Driver Number</label><input id="driverNumber">

  <label>Vehicle Model</label>
  <select id="vehicleModel" onchange="sync(true)">
    <option value="">-- Select --</option>
    <option>Innova Crysta</option>
    <option>Innova Hycross</option>
    <option>Force Urbania</option>
  </select>

  <label>Vehicle Number</label>
  <select id="vehicleNo" onchange="sync(false)">
    <option value="">-- Select --</option>
    <option>PY05N0505</option>
    <option>PY01DB1007</option>
    <option>TN14AP2084</option>
  </select>

  <label>Start Time</label><input type="time" id="startTime" onchange="recalc()">
  <label>End Time</label><input type="time" id="endTime" onchange="recalc()">
  <label>Duration (hrs)</label><input id="duration" readonly>
  <label>Extra Hours</label><input id="extraHours" readonly>

  <label>Start KM</label><input type="number" id="startKM" onchange="recalc()">
  <label>End KM</label><input type="number" id="endKM" onchange="recalc()">
  <label>Total KM</label><input id="totalKM" readonly>
  <label>Extra KM</label><input id="extraKM" readonly>

  <label>Package â‚¹</label><input id="packageCost" readonly>
  <label>Extra Hr â‚¹</label><input id="extraHrCost" readonly>
  <label>Extra KM â‚¹</label><input id="extraKmCost" readonly>
  <label>Toll â‚¹</label><input type="number" id="toll" value="0" onchange="recalc()">
  <label>Parking â‚¹</label><input type="number" id="parking" value="0" onchange="recalc()">
  <label>Total â‚¹</label><input id="totalCost" readonly>
  <label>Note</label><textarea id="note" rows="3" placeholder="Enter notes..."></textarea>

  <!-- Signatures -->
  <label>Customer Signature</label>
  <canvas id="custSign" width="300" height="80" style="border:1px solid #ccc;"></canvas>
  <button type="button" onclick="clearSignature('custSign')">Clear Signature</button>

  <label>Driver Signature</label>
  <canvas id="driverSign" width="300" height="80" style="border:1px solid #ccc;"></canvas>
  <button type="button" onclick="clearSignature('driverSign')">Clear Signature</button>

  <input type="hidden" id="eHr">
  <input type="hidden" id="eKm">
  <input type="hidden" id="freeKm">

  <div class="btn-group">
    <button onclick="saveTrip()">ğŸ’¾ Save</button>
    <button onclick="showTrips()">ğŸ“‘ View All</button>
    <button onclick="shareLast()">ğŸ“¤ WhatsApp</button>
    <button onclick="exportPDF()">ğŸ“„ Export PDF</button>
    <button onclick="repeatLast()">ğŸ” Repeat Trip</button>
  </div>
  <div class="btn-group">
    <button onclick="openDashboard()">ğŸ“Š Dashboard</button>
    <button onclick="openCalendar()">ğŸ“† Calendar</button>
    <button onclick="exportBackup()">ğŸ’¾ Export JSON</button>
    <button onclick="importBackup()">ğŸ“¥ Import JSON</button>
    <button onclick="openRates()">âœï¸ Edit Rates</button>
  </div>
</div>

<!-- Add SignaturePad script in <head> -->
<script src="https://cdn.jsdelivr.net/npm/signature_pad@4.1.6/dist/signature_pad.umd.min.js"></script>

<script>
let langData = {
  en: {
    title: "NST Trip Sheet",
    customerName: "Customer Name",
    driverName: "Driver Name",
    total: "Total â‚¹",
    note: "Note"
  },
  ta: {
    title: "NST à®ªà®¯à®£ à®ªà®Ÿà®¿à®µà®®à¯",
    customerName: "à®µà®¾à®Ÿà®¿à®•à¯à®•à¯ˆà®¯à®¾à®³à®°à¯ à®ªà¯†à®¯à®°à¯",
    driverName: "à®“à®Ÿà¯à®Ÿà¯à®©à®°à¯ à®ªà¯†à®¯à®°à¯",
    total: "à®®à¯Šà®¤à¯à®¤à®®à¯ â‚¹",
    note: "à®•à¯à®±à®¿à®ªà¯à®ªà¯"
  },
  hi: {
    title: "NST à¤¯à¤¾à¤¤à¥à¤°à¤¾ à¤«à¤¼à¥‰à¤°à¥à¤®",
    customerName: "à¤—à¥à¤°à¤¾à¤¹à¤• à¤•à¤¾ à¤¨à¤¾à¤®",
    driverName: "à¤šà¤¾à¤²à¤• à¤•à¤¾ à¤¨à¤¾à¤®",
    total: "à¤•à¥à¤² â‚¹",
    note: "à¤Ÿà¤¿à¤ªà¥à¤ªà¤£à¥€"
  }
};

function switchLang() {
  let lang = langSelect.value || 'en';
  let l = langData[lang] || langData.en;
  document.querySelector('h2').textContent = "ğŸ“ " + l.title;
  document.querySelector("label[for=custName]").textContent = l.customerName;
  document.querySelector("label[for=driverName]").textContent = l.driverName;
  document.querySelector("label[for=totalCost]").textContent = l.total;
  document.querySelector("label[for=note]").textContent = l.note;
}

let custPad = new SignaturePad(document.getElementById("custSign"));
let driverPad = new SignaturePad(document.getElementById("driverSign"));

function clearSignature(id) {
  if (id === 'custSign') custPad.clear();
  if (id === 'driverSign') driverPad.clear();
}

function getSignatureData() {
  return {
    customerSign: custPad.isEmpty() ? "" : custPad.toDataURL(),
    driverSign: driverPad.isEmpty() ? "" : driverPad.toDataURL()
  };
}

function loadSignature(data) {
  if (data.customerSign) custPad.fromDataURL(data.customerSign);
  if (data.driverSign) driverPad.fromDataURL(data.driverSign);
}

function repeatLast() {
  let arr = JSON.parse(localStorage.getItem(TKEY) || '[]');
  if (arr.length === 0) return;
  let last = arr[arr.length - 1];
  editingId = null;
  tripId.value = genId();
  tripDate.value = new Date().toISOString().split('T')[0];
  custName.value = last.cust;
  custNumber.value = last.custNum;
  driverName.value = last.driver;
  driverNumber.value = last.driverNum;
  vehicleModel.value = last.model;
  vehicleNo.value = last.no;
  startTime.value = last.start;
  endTime.value = last.end;
  startKM.value = last.startKM;
  endKM.value = last.endKM;
  note.value = last.note;
  sync(true);
  recalc();
}

function exportBackup() {
  const data = localStorage.getItem(TKEY);
  const blob = new Blob([data], { type: "application/json" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "NST_Trip_Backup.json";
  a.click();
  URL.revokeObjectURL(url);
}

function importBackup() {
  const input = document.createElement("input");
  input.type = "file";
  input.accept = "application/json";
  input.onchange = e => {
    const file = e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = function(event) {
      try {
        const imported = JSON.parse(event.target.result);
        if (Array.isArray(imported)) {
          localStorage.setItem(TKEY, JSON.stringify(imported));
          alert("Trips imported successfully.");
        }
      } catch (e) {
        alert("Invalid JSON file.");
      }
    };
    reader.readAsText(file);
  };
  input.click();
}

function openDashboard() {
  alert("ğŸ“Š Dashboard feature coming in Part 3");
}

function openCalendar() {
  alert("ğŸ“† Calendar view coming in Part 4");
}
</script>
