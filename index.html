<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>NST Trip Sheet</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    body { font-family: 'Segoe UI', Tahoma, sans-serif; margin: 0 auto; padding: 20px; max-width: 800px; background: #f4f6f9; }
    label { font-weight: bold; margin-top: 10px; display: block; }
    input, select, textarea, button { width: 100%; padding: 10px; margin: 5px 0 15px 0; border: 1px solid #ccc; border-radius: 5px; font-size: 16px; }
    button { background: #007bff; color: white; border: none; cursor: pointer; }
    button:hover { background: #0056b3; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 15px; }
    th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
    th { background: #007bff; color: white; }
    h3 { margin-top: 30px; }
  </style>
</head>
<body>
  <h2>üìù NST Trip Sheet</h2>

  <label>Trip ID</label><input id="tripId" readonly>
  <label>Date</label><input type="date" id="tripDate" onchange="updateDateFormat()">
  <div id="tripDateDisplay" style="font-weight:bold; margin-bottom:15px;"></div>

  <label>Customer Name</label><input id="custName">
  <label>Customer Number</label><input id="custNumber">

  <label>Driver Name</label>
  <select id="driverName" onchange="syncDriver(true)">
    <option value="">-- Select --</option>
    <option>Perumal</option>
    <option>Siva</option>
  </select>
  <label>Driver Number</label>
  <select id="driverNumber" onchange="syncDriver(false)">
    <option value="">-- Select --</option>
    <option>9699994563</option>
    <option>9551208961</option>
  </select>

  <label>Vehicle Model</label>
  <select id="vehicleModel" onchange="syncVehicle(true)">
    <option value="">-- Select --</option>
    <option>Innova Crysta</option>
    <option>Innova Hycross</option>
    <option>Force Urbania</option>
  </select>
  <label>Vehicle Number</label>
  <select id="vehicleNo" onchange="syncVehicle(false)">
    <option value="">-- Select --</option>
    <option>PY05N0505</option>
    <option>PY01DB1007</option>
    <option>TN14AP2084</option>
  </select>

  <label>Start Time</label><input type="time" id="startTime">
  <label>End Time</label><input type="time" id="endTime">
  <label>Duration (hrs)</label><input id="duration" readonly>
  <label>Extra Hours</label><input id="extraHours" readonly>

  <label>Start KM</label><input type="number" id="startKM">
  <label>End KM</label><input type="number" id="endKM">
  <label>Total KM</label><input id="totalKM" readonly>
  <label>Extra KM</label><input id="extraKM" readonly>

  <label>Parking ‚Çπ</label><input type="number" id="parking" value="0">
  <label>Toll ‚Çπ</label><input type="number" id="toll" value="0">
  <label>Note</label><textarea id="note" rows="3"></textarea>

  <div style="margin-top: 15px;">
    <button onclick="shareWhatsApp()">üì§ WhatsApp</button>
    <button onclick="showSharedTrips()">üìã View Shared Trips</button>
    <button onclick="exportSharedTrips()">üì• Export Shared Trips (Excel)</button>
  </div>

  <div id="sharedTripsList" style="margin-top: 20px;"></div>

  <script>
    const driverMap = {
      "Perumal": "9699994563",
      "Siva": "9551208961"
    };

    const driverReverseMap = {
      "9699994563": "Perumal",
      "9551208961": "Siva"
    };

    const vehicleMap = {
      "Innova Crysta": "PY05N0505",
      "Innova Hycross": "PY01DB1007",
      "Force Urbania": "TN14AP2084"
    };

    const vehicleReverseMap = {
      "PY05N0505": "Innova Crysta",
      "PY01DB1007": "Innova Hycross",
      "TN14AP2084": "Force Urbania"
    };

    const SHKEY = "shared-trips";

    function syncVehicle(fromModel) {
      if (fromModel) {
        vehicleNo.value = vehicleMap[vehicleModel.value] || '';
      } else {
        vehicleModel.value = vehicleReverseMap[vehicleNo.value] || '';
      }
    }

    function syncDriver(fromName) {
      if (fromName) {
        driverNumber.value = driverMap[driverName.value] || '';
      } else {
        driverName.value = driverReverseMap[driverNumber.value] || '';
      }
    }

    function updateDateFormat() {
      const dateInput = document.getElementById('tripDate');
      const display = document.getElementById('tripDateDisplay');
      if (!dateInput.value) return;
      const d = new Date(dateInput.value);
      const options = { day: '2-digit', month: 'long', year: 'numeric' };
      const formatted = d.toLocaleDateString('en-GB', options);
      display.textContent = "üìÖ " + formatted;
      display.dataset.raw = dateInput.value;
    }

    function formatDate(rawDate) {
      const d = new Date(rawDate);
      return `${String(d.getDate()).padStart(2,'0')}-${String(d.getMonth()+1).padStart(2,'0')}-${d.getFullYear()}`;
    }

    function to12Hr(timeStr) {
      const [h, m] = timeStr.split(":");
      let hour = parseInt(h);
      let suffix = hour >= 12 ? "PM" : "AM";
      hour = hour % 12 || 12;
      return `${hour}:${m} ${suffix}`;
    }

    function reserveNextId() {
      let id = parseInt(localStorage.getItem("lastTripId") || "1");
      localStorage.setItem("lastTripId", id + 1);
      tripId.value = "#NST" + String(id + 1).padStart(3, '0');
    }

    function genId() {
      let id = parseInt(localStorage.getItem("lastTripId") || "1");
      return "#NST" + String(id).padStart(3, '0');
    }

    function shareWhatsApp() {
      const rawDate = tripDateDisplay.dataset.raw;
      if (!rawDate) {
        alert("Please select a trip date.");
        return;
      }

      const tripData = {
        id: tripId.value,
        date: rawDate,
        name: custName.value,
        model: vehicleModel.value
      };

      const msg = `üìã *TRIP SUMMARY*

*TRIP ID:* ${tripData.id}
*DATE:* ${formatDate(rawDate)}

üë§ *CUSTOMER INFO*
‚Ä¢ *Name:* ${custName.value}
‚Ä¢ *Number:* ${custNumber.value}

üë®‚Äç‚úàÔ∏è *DRIVER INFO*
‚Ä¢ *Name:* ${driverName.value}
‚Ä¢ *Number:* ${driverNumber.value}

üöò *VEHICLE INFO*
‚Ä¢ *Model:* ${vehicleModel.value}
‚Ä¢ *Vehicle No:* ${vehicleNo.value}

üïí *TIME & DISTANCE*
‚Ä¢ *Start Time:* ${to12Hr(startTime.value)}
‚Ä¢ *End Time:* ${to12Hr(endTime.value)}
‚Ä¢ *Duration:* ${duration.value || 0} hrs
‚Ä¢ *Extra Hrs:* ${extraHours.value || 0}
‚Ä¢ *Total KM:* ${totalKM.value || 0} km
‚Ä¢ *Extra KM:* ${extraKM.value || 0} km

üí∞ *CHARGES*
‚Ä¢ *Parking:* ‚Çπ${parking.value || 0}
‚Ä¢ *Toll:* ‚Çπ${toll.value || 0}

üìù *Note:* ${note.value || "-"}`;

      window.open("https://wa.me/?text=" + encodeURIComponent(msg), '_blank');
      recordShare(tripData);
      reserveNextId();
    }

    function recordShare(tripData) {
      let shared = JSON.parse(localStorage.getItem(SHKEY) || "[]");
      shared.push({
        id: tripData.id,
        date: formatDate(tripData.date),
        name: tripData.name,
        vehicle: tripData.model
      });
      localStorage.setItem(SHKEY, JSON.stringify(shared));
    }

    function showSharedTrips() {
      const shared = JSON.parse(localStorage.getItem(SHKEY) || "[]");
      const div = document.getElementById("sharedTripsList");

      if (!shared.length) {
        div.innerHTML = "<p>No trips shared yet.</p>";
        return;
      }

      let html = "<h3>üìã Shared Trips History</h3><table><tr><th>Trip ID</th><th>Date</th><th>Customer</th><th>Vehicle</th></tr>";
      shared.forEach(t => {
        html += `<tr><td>${t.id}</td><td>${t.date}</td><td>${t.name}</td><td>${t.vehicle}</td></tr>`;
      });
      html += "</table>";
      div.innerHTML = html;
    }

    function exportSharedTrips() {
      const shared = JSON.parse(localStorage.getItem(SHKEY) || "[]");
      if (!shared.length) {
        alert("No shared trips to export.");
        return;
      }

      const ws = XLSX.utils.json_to_sheet(shared);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "SharedTrips");
      XLSX.writeFile(wb, "Shared_Trips.xlsx");
    }

    tripId.value = genId();
  </script>
</body>
</html>
