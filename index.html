<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>NST Trip Sheet</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Poppins', sans-serif;
      margin: 0 auto;
      padding: 20px;
      max-width: 800px;
      background: #f4f6f9;
    }
    h2 { color: #4b2aad; }
    label {
      font-weight: bold;
      margin-top: 10px;
      display: block;
    }
    input, select, textarea, button {
      width: 100%;
      padding: 10px;
      margin: 5px 0 15px 0;
      border: 1px solid #ccc;
      border-radius: 5px;
      font-size: 16px;
    }
    button {
      background: #4b2aad;
      color: white;
      border: none;
      cursor: pointer;
    }
    button:hover {
      background: #3a208b;
    }
    table { border-collapse: collapse; width: 100%; margin-top: 10px; }
    table th, table td { border: 1px solid #ddd; padding: 8px; }
    table th { background: #4b2aad; color: #fff; }
  </style>
</head>
<body>
  <h2>üìù NST Trip Sheet</h2>

  <label>Trip ID</label><input id="tripId" readonly>

  <label>Date</label>
  <div style="position: relative;">
    <input type="text" id="tripDateDisplay" placeholder="Select Date" readonly style="cursor: pointer;">
    <input type="date" id="tripDate" style="opacity:0; position:absolute; top:0; left:0; width:100%; height:100%; cursor:pointer;">
  </div>

  <label>Customer Name</label><input id="custName">
  <label>Customer Number</label><input id="custNumber">

  <label>Driver Name</label>
  <select id="driverName" onchange="syncDriver(true)">
    <option value="">-- Select --</option>
    <option>Perumal</option>
    <option>Siva</option>
  </select>

  <label>Driver Number</label>
  <select id="driverNumber" onchange="syncDriver(false)">
    <option value="">-- Select --</option>
    <option>9699994563</option>
    <option>9551208961</option>
  </select>

  <label>Vehicle Model</label>
  <select id="vehicleModel" onchange="sync(true)">
    <option value="">-- Select --</option>
    <option>Innova Crysta</option>
    <option>Innova Hycross</option>
    <option>Force Urbania</option>
  </select>

  <label>Vehicle Number</label>
  <select id="vehicleNo" onchange="sync(false)">
    <option value="">-- Select --</option>
    <option>PY05N0505</option>
    <option>PY01DB1007</option>
    <option>TN14AP2084</option>
  </select>

  <label>Start Time</label><input type="time" id="startTime" onchange="recalc()">
  <label>End Time</label><input type="time" id="endTime" onchange="recalc()">
  <label>Duration (hrs)</label><input id="duration" readonly>
  <label>Extra Hours</label><input id="extraHours" readonly>
  <label>Start KM</label><input type="number" id="startKM" onchange="recalc()">
  <label>End KM</label><input type="number" id="endKM" onchange="recalc()">
  <label>Total KM</label><input id="totalKM" readonly>
  <label>Extra KM</label><input id="extraKM" readonly>

  <label>Parking ‚Çπ</label><input type="number" id="parking" value="0">
  <label>Toll ‚Çπ</label><input type="number" id="toll" value="0">

  <label>Note</label><textarea id="note" rows="3" placeholder="Enter any trip notes..."></textarea>

  <div style="margin-top: 15px;">
    <button onclick="shareWhatsApp()">üì§ Share via WhatsApp</button>
    <button onclick="showSharedTrips()">üìã View Shared Trips</button>
    <button onclick="exportSharedTrips()">üì• Export Shared Trips (Excel)</button>
  </div>

  <div id="sharedTripsList"></div>
  <input type="hidden" id="freeKm">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script>
    const rates = {
      "Innova Crysta": { free: 80, no: "PY05N0505" },
      "Innova Hycross": { free: 60, no: "PY01DB1007" },
      "Force Urbania": { free: 70, no: "TN14AP2084" }
    };

    const drivers = {
      "Perumal": "9699994563",
      "Siva": "9551208961"
    };

    const SHKEY = "shared-trips";

    function genId() {
      let n = parseInt(localStorage.getItem("trip-seq") || "1");
      return "#NST" + String(n).padStart(3, "0");
    }

    function reserveNextId() {
      let current = parseInt(localStorage.getItem("trip-seq") || "1");
      localStorage.setItem("#NST" + String(current).padStart(3, "0"), "used");
      localStorage.setItem("trip-seq", current + 1);
      tripId.value = genId();
    }

    function formatDate(raw) {
      const d = new Date(raw);
      const dd = String(d.getDate()).padStart(2, '0');
      const mm = String(d.getMonth() + 1).padStart(2, '0');
      const yyyy = d.getFullYear();
      return `${dd}-${mm}-${yyyy}`;
    }

    function to12Hr(timeStr) {
      if (!timeStr) return "";
      const [h, m] = timeStr.split(":");
      const d = new Date();
      d.setHours(h, m);
      return d.toLocaleTimeString('en-IN', {
        hour: '2-digit', minute: '2-digit', hour12: true, timeZone: 'Asia/Kolkata'
      });
    }

    function sync(fromModel) {
      if (fromModel) {
        let model = vehicleModel.value;
        if (rates[model]) {
          vehicleNo.value = rates[model].no;
          freeKm.value = rates[model].free;
        }
      } else {
        let no = vehicleNo.value;
        for (let model in rates) {
          if (rates[model].no === no) {
            vehicleModel.value = model;
            sync(true);
            break;
          }
        }
      }
      recalc();
    }

    function syncDriver(fromName) {
      if (fromName) {
        driverNumber.value = drivers[driverName.value] || "";
      } else {
        const num = driverNumber.value;
        for (let n in drivers) {
          if (drivers[n] === num) {
            driverName.value = n;
            break;
          }
        }
      }
    }

    function recalc() {
      if (startTime.value && endTime.value) {
        let s = new Date(`1970-01-01T${startTime.value}`);
        let e = new Date(`1970-01-01T${endTime.value}`);
        let diff = (e - s) / 3600000;
        if (diff < 0) diff += 24;
        let hrs = Math.ceil(diff);
        duration.value = hrs;
        extraHours.value = hrs > 8 ? hrs - 8 : 0;
      }
      let totKm = endKM.value - startKM.value;
      totalKM.value = totKm;
      extraKM.value = totKm > freeKm.value ? totKm - freeKm.value : 0;
    }

    function recordShare(tripData) {
      let shared = JSON.parse(localStorage.getItem(SHKEY) || "[]");
      shared.push({
        id: tripData.id,
        date: formatDate(tripData.date),
        name: tripData.name,
        vehicle: tripData.model
      });
      localStorage.setItem(SHKEY, JSON.stringify(shared));
    }

    function shareWhatsApp() {
      const rawDate = tripDateDisplay.dataset.raw;
      if (!rawDate) { alert("Please select date before sharing."); return; }

      const tripData = {
        id: tripId.value,
        date: rawDate,
        name: custName.value,
        model: vehicleModel.value
      };

      const msg = `üìã *TRIP SUMMARY*

*TRIP ID:* ${tripData.id}
*DATE:* ${formatDate(rawDate)}

üë§ *CUSTOMER INFO*
‚Ä¢ *Name:* ${custName.value}
‚Ä¢ *Number:* ${custNumber.value}

üë®‚Äç‚úàÔ∏è *DRIVER INFO*
‚Ä¢ *Name:* ${driverName.value}
‚Ä¢ *Number:* ${driverNumber.value}

üöò *VEHICLE INFO*
‚Ä¢ *Model:* ${vehicleModel.value}
‚Ä¢ *Vehicle No:* ${vehicleNo.value}

üïí *TIME & DISTANCE*
‚Ä¢ *Start Time:* ${to12Hr(startTime.value)}
‚Ä¢ *End Time:* ${to12Hr(endTime.value)}
‚Ä¢ *Duration:* ${duration.value || 0} hrs
‚Ä¢ *Extra Hrs:* ${extraHours.value || 0}
‚Ä¢ *Total KM:* ${totalKM.value || 0} km
‚Ä¢ *Extra KM:* ${extraKM.value || 0} km

üí∞ *CHARGES*
‚Ä¢ *Parking:* ‚Çπ${parking.value || 0}
‚Ä¢ *Toll:* ‚Çπ${toll.value || 0}

üìù *Note:* ${note.value || "-"}`;

      window.open("https://wa.me/?text=" + encodeURIComponent(msg), '_blank');
      recordShare(tripData);
      reserveNextId();
    }

    function exportSharedTrips() {
      const shared = JSON.parse(localStorage.getItem(SHKEY) || "[]");
      if (!shared.length) { alert("No shared trips yet."); return; }
      const ws = XLSX.utils.json_to_sheet(shared);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "SharedTrips");
      XLSX.writeFile(wb, "Shared_Trips.xlsx");
    }

    function showSharedTrips() {
      const shared = JSON.parse(localStorage.getItem(SHKEY) || "[]");
      const div = document.getElementById("sharedTripsList");
      if (!shared.length) { div.innerHTML = "<p>No trips shared yet.</p>"; return; }

      let html = "<h3>üìã Shared Trips History</h3><table><tr><th>Trip ID</th><th>Date</th><th>Customer</th><th>Vehicle</th></tr>";
      shared.forEach(t => html += `<tr><td>${t.id}</td><td>${t.date}</td><td>${t.name}</td><td>${t.vehicle}</td></tr>`);
      html += "</table>";
      div.innerHTML = html;
    }

    // Date Picker Logic
    const tripDateDisplay = document.getElementById("tripDateDisplay");
    const tripDate = document.getElementById("tripDate");

    tripDate.addEventListener("change", () => {
      const raw = tripDate.value;
      if (!raw) return;
      const d = new Date(raw);
      tripDateDisplay.value = d.toLocaleDateString("en-GB", {
        day: '2-digit', month: 'long', year: 'numeric', timeZone: 'Asia/Kolkata'
      });
      tripDateDisplay.dataset.raw = raw;
    });

    // Initialize
    tripId.value = genId();
  </script>
</body>
</html>
