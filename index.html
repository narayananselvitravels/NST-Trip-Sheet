<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>NST Trip Sheet</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <style>
    body { font-family:'Poppins',sans-serif;margin:0 auto;padding:20px;max-width:800px;background:#f4f6f9 }
    h2 { color:#4b2aad }
    label { font-weight:bold;margin-top:10px;display:block }
    input, select, textarea, button {
      width:100%;padding:10px;margin:5px 0 15px;
      border:1px solid #ccc;border-radius:5px;font-size:16px
    }
    button { background:#4b2aad;color:#fff;border:none;cursor:pointer }
    button:hover { background:#3a208b }
  </style>
</head>
<body>

<h2>ğŸ“ NST Trip Sheet</h2>

<label>Trip ID</label><input id="tripId" readonly>

<label>Date</label>
<div style="position:relative">
  <input type="text" id="tripDateDisplay" placeholder="Select Date" readonly style="cursor:pointer">
  <input type="date" id="tripDate" style="opacity:0;position:absolute;top:0;left:0;width:100%;height:100%;cursor:pointer">
</div>

<label>Pickup Location</label>
<input type="text" id="pickupLocation" placeholder="Enter pickup location">

<label>Drop Location</label>
<input type="text" id="dropLocation" placeholder="Enter drop location">

<label>Customer Name</label><input id="custName">
<label>Customer Number</label><input id="custNumber">

<label>Driver Name</label>
<select id="driverName" onchange="syncDriver(true)"><option value="">-- Select --</option></select>

<label>Driver Number</label>
<select id="driverNumber" onchange="syncDriver(false)"><option value="">-- Select --</option></select>

<label>Vehicle Model</label>
<select id="vehicleModel" onchange="syncVehicle(true)"><option value="">-- Select --</option></select>

<label>Vehicle Number</label>
<select id="vehicleNo" onchange="syncVehicle(false)"><option value="">-- Select --</option></select>

<label>Start Time</label><input type="time" id="startTime">
<label>End Time</label><input type="time" id="endTime">

<label>Duration (hrs)</label><input id="duration">
<label>Extra Hours</label><input id="extraHours">

<label>Start KM</label><input type="number" id="startKM">
<label>End KM</label><input type="number" id="endKM">

<label>Total KM</label><input id="totalKM">
<label>Extra KM</label><input id="extraKM">

<label>Total Amount â‚¹</label><input id="totalAmount" type="number">
<label>Status</label>
<select id="status">
  <option value="Paid">Paid</option>
  <option value="Not Paid">Not Paid</option>
</select>

<label>Parking â‚¹</label><input type="number" id="parking" value="0">
<label>Toll â‚¹</label><input type="number" id="toll" value="0">

<label>Note</label><textarea id="note" rows="3" placeholder="Enter any trip notes..."></textarea>

<button onclick="shareWhatsApp()">ğŸ“¤ Share via WhatsApp</button>

<script>
const SHKEY = "shared-trips";

// Load driver and vehicle options
function loadDropdowns() {
  const drivers = JSON.parse(localStorage.getItem("driver-master") || "[]");
  const vehicles = JSON.parse(localStorage.getItem("vehicle-master") || "[]");

  drivers.forEach(d => {
    driverName.innerHTML += `<option>${d.name}</option>`;
    driverNumber.innerHTML += `<option>${d.mobile}</option>`;
  });

  vehicles.forEach(v => {
    vehicleModel.innerHTML += `<option>${v.model}</option>`;
    vehicleNo.innerHTML += `<option>${v.number}</option>`;
  });
}

// ID & Date
function genId() {
  let n = parseInt(localStorage.getItem("trip-seq")||"1");
  return "#NST"+String(n).padStart(3,"0");
}
function reserveNextId() {
  let c = parseInt(localStorage.getItem("trip-seq")||"1");
  localStorage.setItem("trip-seq",c+1);
}
tripId.value = genId();
tripDate.addEventListener("change", () => {
  const raw = tripDate.value, d=new Date(raw);
  tripDateDisplay.value = d.toLocaleDateString("en-GB", {day:'2-digit',month:'long',year:'numeric'});
  tripDateDisplay.dataset.raw = raw;
});

function syncDriver(fromName) {
  const drivers = JSON.parse(localStorage.getItem("driver-master") || "[]");
  if (fromName) {
    const selected = drivers.find(d => d.name === driverName.value);
    if (selected) driverNumber.value = selected.mobile;
  } else {
    const selected = drivers.find(d => d.mobile === driverNumber.value);
    if (selected) driverName.value = selected.name;
  }
}
function syncVehicle(fromModel) {
  const vehicles = JSON.parse(localStorage.getItem("vehicle-master") || "[]");
  if (fromModel) {
    const selected = vehicles.find(v => v.model === vehicleModel.value);
    if (selected) vehicleNo.value = selected.number;
  } else {
    const selected = vehicles.find(v => v.number === vehicleNo.value);
    if (selected) vehicleModel.value = selected.model;
  }
}

function to12Hr(t) {
  if (!t) return "";
  const [h,m]=t.split(":"); let d=new Date(); d.setHours(h,m);
  return d.toLocaleTimeString('en-IN',{hour:'2-digit',minute:'2-digit',hour12:true});
}

function shareWhatsApp() {
  const rawDate = tripDateDisplay.dataset.raw;
  if (!rawDate) return alert("Select date");

  const data = {
    id: tripId.value,
    date: rawDate,
    pickup: pickupLocation.value,
    drop: dropLocation.value,
    custName: custName.value,
    custNo: custNumber.value,
    driverName: driverName.value,
    driverNo: driverNumber.value,
    model: vehicleModel.value,
    vehicleNo: vehicleNo.value,
    start: startTime.value,
    end: endTime.value,
    duration: duration.value,
    extraH: extraHours.value,
    totalKM: totalKM.value,
    extraKM: extraKM.value,
    totalAmount: totalAmount.value,
    status: status.value,
    parking: parking.value,
    toll: toll.value,
    note: note.value
  };

  const msg = `ğŸ“‹ *TRIP SUMMARY*\n\n*TRIP ID:* ${data.id}\n*DATE:* ${tripDateDisplay.value}\n\n` +
    `ğŸ“ *Pickup:* ${data.pickup}\nğŸ“ *Drop:* ${data.drop}\n\n` +
    `ğŸ‘¤ *Customer:* ${data.custName} (${data.custNo})\n` +
    `ğŸ‘¨â€âœˆï¸ *Driver:* ${data.driverName} (${data.driverNo})\n` +
    `ğŸš˜ *Vehicle:* ${data.model} â€“ ${data.vehicleNo}\n\n` +
    `ğŸ•’ *Time:* ${to12Hr(data.start)} to ${to12Hr(data.end)}\n` +
    `ğŸ“ *Duration:* ${data.duration} hrs | Extra Hrs: ${data.extraH}\n` +
    `ğŸ“ *KM:* ${data.totalKM} km | Extra KM: ${data.extraKM}\n\n` +
    `ğŸ’° *Amount:* â‚¹${data.totalAmount} | ${data.status}\nğŸš§ Parking: â‚¹${data.parking} | Toll: â‚¹${data.toll}\n\n` +
    `ğŸ“ Note: ${data.note || "-"}`;

  window.open("https://wa.me/?text=" + encodeURIComponent(msg), "_blank");

  // Save
  let trips = JSON.parse(localStorage.getItem(SHKEY) || "[]");
  trips.push(data);
  localStorage.setItem(SHKEY, JSON.stringify(trips));

  reserveNextId();
  tripId.value = genId();
}
loadDropdowns();
</script>

<!-- Google Places API -->
<script>
let pickupAutocomplete, dropAutocomplete;
function initAutocomplete() {
  pickupAutocomplete = new google.maps.places.Autocomplete(
    document.getElementById("pickupLocation"),
    { types: ["geocode"], componentRestrictions: { country: "in" } }
  );
  dropAutocomplete = new google.maps.places.Autocomplete(
    document.getElementById("dropLocation"),
    { types: ["geocode"], componentRestrictions: { country: "in" } }
  );
}
</script>
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAFSQJTGHRBDbW_ph7kV2VPT5psO9wfDHQ&libraries=places&callback=initAutocomplete" async defer></script>

</body>
</html>
