<!DOCTYPE html>
<html lang="en">
<head><meta charset="UTF-8"><title>NST Trip Sheet</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    body{font-family:Poppins,sans-serif;margin:20px auto;max-width:800px;background:#f4f6f9;padding:20px;}
    h2{color:#4b2aad;}label{display:block;margin-top:10px;font-weight:600;}
    input,select,textarea,button{width:100%;padding:10px;margin:5px 0;border:1px solid #ccc;border-radius:5px;}
    button{background:#4b2aad;color:white;border:none;cursor:pointer;}
    button:hover{background:#3a208b;}
    table{width:100%;border-collapse:collapse;margin-top:20px;}
    th,td{border:1px solid #ddd;padding:8px;text-align:left;}
    th{background:#4b2aad;color:white;}
  </style>
</head>
<body>
<h2>üìù NST Trip Sheet</h2>

<label>Trip ID</label><input id="tripId" readonly>
<label>Date</label>
<div style="position:relative">
  <input id="tripDateDisplay" placeholder="Select Date" readonly style="cursor:pointer">
  <input type="date" id="tripDate" style="position:absolute;opacity:0;top:0;left:0;width:100%;height:100%;cursor:pointer;">
</div>

<label>Customer Name</label><input id="custName">
<label>Customer Number</label><input id="custNumber">

<label>Driver Name</label><select id="driverName" onchange="syncDriver(true)"></select>
<label>Driver Number</label><select id="driverNumber" onchange="syncDriver(false)"></select>

<label>Vehicle Model</label><select id="vehicleModel" onchange="syncVehicle(true)"></select>
<label>Vehicle Number</label><select id="vehicleNo" onchange="syncVehicle(false)"></select>

<label>Start Time</label><input type="time" id="startTime" onchange="recalc()">
<label>End Time</label><input type="time" id="endTime" onchange="recalc()">
<label>Duration (hrs)</label><input id="duration" readonly>
<label>Extra Hours</label><input id="extraHours" readonly>

<label>Start KM</label><input type="number" id="startKM" onchange="recalc()">
<label>End KM</label><input type="number" id="endKM" onchange="recalc()">
<label>Total KM</label><input id="totalKM" readonly>
<label>Extra KM</label><input id="extraKM" readonly>

<label>Parking ‚Çπ</label><input type="number" id="parking" value="0">
<label>Toll ‚Çπ</label><input type="number" id="toll" value="0">
<label>Note</label><textarea id="note"></textarea>

<div>
  <button onclick="shareWhatsApp()">üì§ Share via WhatsApp</button>
  <button onclick="showSharedTrips()">üìã View Shared Trips</button>
  <button onclick="exportTrips()">üì• Export Trips</button>
  <button onclick="document.getElementById('adminLogin').style.display='block'" style="background:#6c757d">üîê Admin Panel</button>
</div>

<div id="sharedTripsList"></div>

<div id="adminLogin" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);">
  <div style="background:white;max-width:300px;margin:100px auto;padding:20px;border-radius:5px;">
    <h3>üîê Admin Login</h3>
    <label>Username</label><input id="adminUser">
    <label>Password</label><input type="password" id="adminPass">
    <button onclick="loginAdmin()">Login</button>
    <button onclick="document.getElementById('adminLogin').style.display='none'" style="background:#dc3545;margin-top:10px">Cancel</button>
  </div>
</div>

<script>
const DRV_KEY="driver-master", VEH_KEY="vehicle-master", TRIP_KEY="shared-trips", SEQ_KEY="trip-seq";

function load(key){return JSON.parse(localStorage.getItem(key)||"[]");}
function save(key,arr){localStorage.setItem(key,JSON.stringify(arr));}
function fmtDate(raw){const d=new Date(raw); return `${String(d.getDate()).padStart(2,"0")}-${String(d.getMonth()+1).padStart(2,"0")}-${d.getFullYear()}`;}
function to12Hr(t){ if(!t) return ""; const [h,m]=t.split(":"); const d=new Date(); d.setHours(h,m); return d.toLocaleTimeString('en-IN',{hour:'2-digit',minute:'2-digit',hour12:true});}
function genId(){return "#NST" + String(parseInt(localStorage.getItem(SEQ_KEY)||"1")).padStart(3,"0");}
function incSeq(){let n=parseInt(localStorage.getItem(SEQ_KEY)||"1");localStorage.setItem(SEQ_KEY,n+1); tripId.value=genId();}

function populate(){
  const dr=load(DRV_KEY), vh=load(VEH_KEY);
  driverName.innerHTML="<option>-- Select --</option>"+dr.map(d=>`<option>${d.name}</option>`).join("");
  driverNumber.innerHTML="<option>-- Select --</option>"+dr.map(d=>`<option>${d.number}</option>`).join("");
  vehicleModel.innerHTML="<option>-- Select --</option>"+vh.map(v=>`<option>${v.model}</option>`).join("");
  vehicleNo.innerHTML="<option>-- Select --</option>"+vh.map(v=>`<option>${v.number}</option>`).join("");
}

function syncDriver(fromName){
  const dr=load(DRV_KEY);
  if(fromName){
    const sel=dr.find(d=>d.name===driverName.value);
    driverNumber.value=sel?.number||"";
  } else {
    const sel=dr.find(d=>d.number===driverNumber.value);
    driverName.value=sel?.name||"";
  }
}

function syncVehicle(fromMod){
  const vh=load(VEH_KEY);
  if(fromMod){
    const sel=vh.find(v=>v.model===vehicleModel.value);
    vehicleNo.value=sel?.number||"";
  } else {
    const sel=vh.find(v=>v.number===vehicleNo.value);
    vehicleModel.value=sel?.model||"";
  }
  recalc();
}

function recalc(){
  const vh=load(VEH_KEY).find(v=>v.model===vehicleModel.value);
  const freeH=vh?.freeHrs||8, freeK=vh?.freeKm||80;

  if(startTime.value && endTime.value){
    let s=new Date(`1970-01-01T${startTime.value}`),
        e=new Date(`1970-01-01T${endTime.value}`),
        diff=(e-s)/3600000;
    if(diff<0) diff+=24;
    duration.value=Math.ceil(diff);
    extraHours.value=Math.max(0,Math.ceil(diff)-freeH);
  }
  if(startKM.value && endKM.value){
    let t=endKM.value-startKM.value;
    totalKM.value=t;
    extraKM.value=Math.max(0,t-freeK);
  }
}

function shareWhatsApp(){
  if(!tripDateDisplay.dataset.raw) return alert("Select Date");
  const data={
    id:tripId.value, date:tripDateDisplay.dataset.raw,
    custName:custName.value, custNo:custNumber.value,
    driverName:driverName.value, driverNo:driverNumber.value,
    model:vehicleModel.value, vehicleNo:vehicleNo.value,
    start:startTime.value, end:endTime.value,
    duration:duration.value, extraH:extraHours.value,
    totalKM:totalKM.value, extraKM:extraKM.value,
    parking:parking.value, toll:toll.value, note:note.value
  };
  const msg=`üìã *TRIP SUMMARY*\n\n*TRIP ID:* ${data.id}\n*DATE:* ${fmtDate(data.date)}\n\n`+
    `üë§ *CUSTOMER INFO*\n‚Ä¢ *Name:* ${data.custName}\n‚Ä¢ *Number:* ${data.custNo}\n\n`+
    `üë®‚Äç‚úàÔ∏è *DRIVER INFO*\n‚Ä¢ *Name:* ${data.driverName}\n‚Ä¢ *Number:* ${data.driverNo}\n\n`+
    `üöò *VEHICLE INFO*\n‚Ä¢ *Model:* ${data.model}\n‚Ä¢ *Vehicle No:* ${data.vehicleNo}\n\n`+
    `üïí *TIME & DISTANCE*\n‚Ä¢ *Start Time:* ${to12Hr(data.start)}\n‚Ä¢ *End Time:* ${to12Hr(data.end)}\n`+
    `‚Ä¢ *Duration:* ${data.duration} hrs\n‚Ä¢ *Extra Hrs:* ${data.extraH}\n‚Ä¢ *Total KM:* ${data.totalKM} km\n‚Ä¢ *Extra KM:* ${data.extraKM} km\n\n`+
    `üí∞ *Parking:* ‚Çπ${data.parking} ‚Ä¢ *Toll:* ‚Çπ${data.toll}\n\nüìù *Note:* ${data.note||"-"}`;

  window.open("https://wa.me/?text="+encodeURIComponent(msg),"_blank");
  const arr=load(TRIP_KEY);
  arr.push(data);
  save(TRIP_KEY,arr);
  incSeq();
}

function showSharedTrips(){
  const arr=load(TRIP_KEY);
  const div=sharedTripsList;
  if(!arr.length){div.innerHTML="<p>No trips yet.</p>";return;}
  let html=`<table><tr><th>ID</th><th>Date</th><th>Customer</th><th>Driver</th><th>Vehicle</th><th>Total KM</th></tr>`;
  arr.forEach(r=>html+=`<tr><td>${r.id}</td><td>${fmtDate(r.date)}</td><td>${r.custName}</td><td>${r.driverName}</td><td>${r.model}</td><td>${r.totalKM}</td></tr>`);
  div.innerHTML=html+"</table>";
}

function exportTrips(){
  const arr=load(TRIP_KEY);
  if(!arr.length)return alert("No Data");
  const wb=XLSX.utils.book_new(),
      ws=XLSX.utils.json_to_sheet(arr);
  XLSX.utils.book_append_sheet(wb,ws,"Trips");
  XLSX.writeFile(wb,"NST_Shared_Trips.xlsx");
}

function loginAdmin(){
  if(adminUser.value==="admin" && adminPass.value==="1234") window.location="admin.html";
  else alert("‚ùå Invalid credentials");
}

tripDate.addEventListener("change",()=>{
  const raw=tripDate.value;
  tripDateDisplay.value=new Date(raw).toLocaleDateString("en-GB", {day:'2-digit',month:'long',year:'numeric'});
  tripDateDisplay.dataset.raw=raw;
});

tripId.value=genId();
populate();
</script>
</body>
</html>
