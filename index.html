<body>
<h2>ğŸ“ NST Trip Sheet</h2>
<div id="mainForm">
  <label>Language</label>
  <select id="lang" onchange="switchLang()">
    <option value="en">English</option>
    <option value="ta">à®¤à®®à®¿à®´à¯</option>
    <option value="hi">à¤¹à¤¿à¤‚à¤¦à¥€</option>
  </select>

  <label>Trip ID</label><input id="tripId" readonly>
  <label>Date</label><input type="date" id="tripDate">
  <label>Customer Name</label><input id="custName">
  <label>Customer Number</label><input id="custNumber">
  <label>Driver Name</label><input id="driverName">
  <label>Driver Number</label><input id="driverNumber">

  <label>Vehicle Model</label>
  <select id="vehicleModel" onchange="sync(true)">
    <option value="">-- Select --</option>
    <option>Innova Crysta</option>
    <option>Innova Hycross</option>
    <option>Force Urbania</option>
  </select>

  <label>Vehicle Number</label>
  <select id="vehicleNo" onchange="sync(false)">
    <option value="">-- Select --</option>
    <option>PY05N0505</option>
    <option>PY01DB1007</option>
    <option>TN14AP2084</option>
  </select>

  <label>Start Time</label><input type="time" id="startTime" onchange="recalc()">
  <label>End Time</label><input type="time" id="endTime" onchange="recalc()">
  <label>Duration (hrs)</label><input id="duration" readonly>
  <label>Extra Hours</label><input id="extraHours" readonly>

  <label>Start KM</label><input type="number" id="startKM" onchange="recalc()">
  <label>End KM</label><input type="number" id="endKM" onchange="recalc()">
  <label>Total KM</label><input id="totalKM" readonly>
  <label>Extra KM</label><input id="extraKM" readonly>

  <label>Package â‚¹</label><input id="packageCost" readonly>
  <label>Extra Hr â‚¹</label><input id="extraHrCost" readonly>
  <label>Extra KM â‚¹</label><input id="extraKmCost" readonly>
  <label>Toll â‚¹</label><input type="number" id="toll" value="0" onchange="recalc()">
  <label>Parking â‚¹</label><input type="number" id="parking" value="0" onchange="recalc()">
  <label>Total â‚¹</label><input id="totalCost" readonly>
  <label>Note</label><textarea id="note" rows="3" placeholder="Enter notes..."></textarea>

  <!-- Signatures -->
  <label>Customer Signature</label>
  <canvas id="custSign" width="300" height="80" style="border:1px solid #ccc;"></canvas>
  <button type="button" onclick="clearSignature('custSign')">Clear Signature</button>

  <label>Driver Signature</label>
  <canvas id="driverSign" width="300" height="80" style="border:1px solid #ccc;"></canvas>
  <button type="button" onclick="clearSignature('driverSign')">Clear Signature</button>

  <input type="hidden" id="eHr">
  <input type="hidden" id="eKm">
  <input type="hidden" id="freeKm">

  <div class="btn-group">
    <button onclick="saveTrip()">ğŸ’¾ Save</button>
    <button onclick="showTrips()">ğŸ“‘ View All</button>
    <button onclick="shareLast()">ğŸ“¤ WhatsApp</button>
    <button onclick="exportPDF()">ğŸ“„ Export PDF</button>
    <button onclick="repeatLast()">ğŸ” Repeat Trip</button>
  </div>
  <div class="btn-group">
    <button onclick="openDashboard()">ğŸ“Š Dashboard</button>
    <button onclick="openCalendar()">ğŸ“† Calendar</button>
    <button onclick="exportBackup()">ğŸ’¾ Export JSON</button>
    <button onclick="importBackup()">ğŸ“¥ Import JSON</button>
    <button onclick="openRates()">âœï¸ Edit Rates</button>
  </div>
</div>

<!-- Add SignaturePad script in <head> -->
<script src="https://cdn.jsdelivr.net/npm/signature_pad@4.1.6/dist/signature_pad.umd.min.js"></script>

<script>
let langData = {
  en: {
    title: "NST Trip Sheet",
    customerName: "Customer Name",
    driverName: "Driver Name",
    total: "Total â‚¹",
    note: "Note"
  },
  ta: {
    title: "NST à®ªà®¯à®£ à®ªà®Ÿà®¿à®µà®®à¯",
    customerName: "à®µà®¾à®Ÿà®¿à®•à¯à®•à¯ˆà®¯à®¾à®³à®°à¯ à®ªà¯†à®¯à®°à¯",
    driverName: "à®“à®Ÿà¯à®Ÿà¯à®©à®°à¯ à®ªà¯†à®¯à®°à¯",
    total: "à®®à¯Šà®¤à¯à®¤à®®à¯ â‚¹",
    note: "à®•à¯à®±à®¿à®ªà¯à®ªà¯"
  },
  hi: {
    title: "NST à¤¯à¤¾à¤¤à¥à¤°à¤¾ à¤«à¤¼à¥‰à¤°à¥à¤®",
    customerName: "à¤—à¥à¤°à¤¾à¤¹à¤• à¤•à¤¾ à¤¨à¤¾à¤®",
    driverName: "à¤šà¤¾à¤²à¤• à¤•à¤¾ à¤¨à¤¾à¤®",
    total: "à¤•à¥à¤² â‚¹",
    note: "à¤Ÿà¤¿à¤ªà¥à¤ªà¤£à¥€"
  }
};

function switchLang() {
  let lang = langSelect.value || 'en';
  let l = langData[lang] || langData.en;
  document.querySelector('h2').textContent = "ğŸ“ " + l.title;
  document.querySelector("label[for=custName]").textContent = l.customerName;
  document.querySelector("label[for=driverName]").textContent = l.driverName;
  document.querySelector("label[for=totalCost]").textContent = l.total;
  document.querySelector("label[for=note]").textContent = l.note;
}

let custPad = new SignaturePad(document.getElementById("custSign"));
let driverPad = new SignaturePad(document.getElementById("driverSign"));

function clearSignature(id) {
  if (id === 'custSign') custPad.clear();
  if (id === 'driverSign') driverPad.clear();
}

function getSignatureData() {
  return {
    customerSign: custPad.isEmpty() ? "" : custPad.toDataURL(),
    driverSign: driverPad.isEmpty() ? "" : driverPad.toDataURL()
  };
}

function loadSignature(data) {
  if (data.customerSign) custPad.fromDataURL(data.customerSign);
  if (data.driverSign) driverPad.fromDataURL(data.driverSign);
}

function repeatLast() {
  let arr = JSON.parse(localStorage.getItem(TKEY) || '[]');
  if (arr.length === 0) return;
  let last = arr[arr.length - 1];
  editingId = null;
  tripId.value = genId();
  tripDate.value = new Date().toISOString().split('T')[0];
  custName.value = last.cust;
  custNumber.value = last.custNum;
  driverName.value = last.driver;
  driverNumber.value = last.driverNum;
  vehicleModel.value = last.model;
  vehicleNo.value = last.no;
  startTime.value = last.start;
  endTime.value = last.end;
  startKM.value = last.startKM;
  endKM.value = last.endKM;
  note.value = last.note;
  sync(true);
  recalc();
}

function exportBackup() {
  const data = localStorage.getItem(TKEY);
  const blob = new Blob([data], { type: "application/json" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "NST_Trip_Backup.json";
  a.click();
  URL.revokeObjectURL(url);
}

function importBackup() {
  const input = document.createElement("input");
  input.type = "file";
  input.accept = "application/json";
  input.onchange = e => {
    const file = e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = function(event) {
      try {
        const imported = JSON.parse(event.target.result);
        if (Array.isArray(imported)) {
          localStorage.setItem(TKEY, JSON.stringify(imported));
          alert("Trips imported successfully.");
        }
      } catch (e) {
        alert("Invalid JSON file.");
      }
    };
    reader.readAsText(file);
  };
  input.click();
}

function openDashboard() {
  alert("ğŸ“Š Dashboard feature coming in Part 3");
}

function openCalendar() {
  alert("ğŸ“† Calendar view coming in Part 4");
}
</script>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<div class="popup" id="dashboardPopup">
  <h3>ğŸ“Š Trip Dashboard</h3>
  <div id="dashboardSummary"></div>
  <canvas id="tripChart" width="100%" height="200"></canvas>
  <canvas id="modelChart" width="100%" height="200"></canvas>
  <button onclick="dashboardPopup.style.display='none'">Close</button>
</div>

function openDashboard() {
  const trips = JSON.parse(localStorage.getItem(TKEY) || '[]');
  const summary = {
    totalTrips: trips.length,
    totalRevenue: 0,
    models: {}
  };

  trips.forEach(t => {
    summary.totalRevenue += Number(t.total || 0);
    summary.models[t.model] = (summary.models[t.model] || 0) + 1;
  });

  // HTML Summary
  dashboardSummary.innerHTML = `
    <p><b>Total Trips:</b> ${summary.totalTrips}</p>
    <p><b>Total Revenue:</b> â‚¹${summary.totalRevenue.toLocaleString()}</p>
  `;

  // Destroy old charts if any
  if (window.tripChartObj) window.tripChartObj.destroy();
  if (window.modelChartObj) window.modelChartObj.destroy();

  // Revenue by Trip Chart (Bar)
  window.tripChartObj = new Chart(tripChart, {
    type: 'bar',
    data: {
      labels: trips.map(t => t.id),
      datasets: [{
        label: 'Trip Revenue â‚¹',
        data: trips.map(t => Number(t.total || 0)),
        backgroundColor: '#4b2aad'
      }]
    },
    options: {
      responsive: true,
      plugins: {
        legend: { display: false }
      }
    }
  });

  // Model Usage Pie Chart
  const models = Object.keys(summary.models);
  window.modelChartObj = new Chart(modelChart, {
    type: 'pie',
    data: {
      labels: models,
      datasets: [{
        data: models.map(m => summary.models[m]),
        backgroundColor: ['#4b2aad', '#007bff', '#ff9800']
      }]
    },
    options: {
      responsive: true
    }
  });

  dashboardPopup.style.display = 'block';
}

<link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js"></script>

<div class="popup" id="calendarPopup">
  <h3>ğŸ“† Trip Calendar</h3>
  <div id="calendarView"></div>
  <button onclick="calendarPopup.style.display='none'">Close</button>
</div>

function openCalendar() {
  const trips = JSON.parse(localStorage.getItem(TKEY) || '[]');
  const events = trips.map(t => ({
    title: t.id + " â€“ " + t.model,
    start: t.date,
    id: t.id
  }));

  if (window.fullCalendarObj) window.fullCalendarObj.destroy();

  const calendarEl = document.getElementById("calendarView");
  window.fullCalendarObj = new FullCalendar.Calendar(calendarEl, {
    initialView: 'dayGridMonth',
    height: 500,
    events,
    eventClick: function(info) {
      editTrip(info.event.id);
      calendarPopup.style.display = 'none';
    }
  });

  window.fullCalendarObj.render();
  calendarPopup.style.display = 'block';
}

<input type="text" id="tripSearch" placeholder="ğŸ” Search trips..." oninput="searchTrips()">

function showTrips() {
  const all = JSON.parse(localStorage.getItem(TKEY) || '[]');
  window.tripSearchData = all;
  renderTripList(all);
  tripPopup.style.display = 'block';
}
function renderTripList(list) {
  tripList.innerHTML = list.map(t => `
    <div class="trip-card">
      <b>${t.id}</b> (${formatDate(t.date)})<br>
      ${t.model} - ${t.no}<br>
      ${to12Hr(t.start)} â†’ ${to12Hr(t.end)} (${t.duration}h)<br>
      Extra Hr: ${t.extraHr} | Extra KM: ${t.extraKM}<br>
      Toll: â‚¹${t.toll} | Parking: â‚¹${t.park}<br>
      <b>Total: â‚¹${t.total}</b>
      <div class="trip-actions">
        <button onclick="editTrip('${t.id}')">âœï¸ Edit</button>
        <button onclick="deleteTrip('${t.id}')">âŒ Delete</button>
        <button onclick="shareTrip('${t.id}')">ğŸ“¤ Share</button>
      </div>
    </div>
  `).join('') || 'No trips found';
}

function searchTrips() {
  const q = tripSearch.value.toLowerCase();
  const result = (window.tripSearchData || []).filter(t =>
    t.id.toLowerCase().includes(q) ||
    t.cust.toLowerCase().includes(q) ||
    t.driver.toLowerCase().includes(q) ||
    t.model.toLowerCase().includes(q) ||
    formatDate(t.date).includes(q)
  );
  renderTripList(result);
}
function exportPDF() {
  const trips = JSON.parse(localStorage.getItem(TKEY) || '[]');
  trips.forEach(t => {
    let content = `
    <div class="invoice">
      <h2>NST Travels â€“ Trip Invoice</h2>
      <div><strong>Trip ID:</strong> ${t.id}</div>
      <div><strong>Date:</strong> ${formatDate(t.date)}</div>
      <div class="section-title">Customer Info</div>
      <div>Name: ${t.cust} | Number: ${t.custNum}</div>
      <div class="section-title">Driver Info</div>
      <div>Name: ${t.driver} | Number: ${t.driverNum}</div>
      <div class="section-title">Vehicle Info</div>
      <div>Model: ${t.model} | Number: ${t.no}</div>
      <div class="section-title">Time & Distance</div>
      <table class="invoice-table">
        <tr><th>Start</th><th>End</th><th>Duration</th><th>Extra Hr</th><th>Total KM</th><th>Extra KM</th></tr>
        <tr><td>${to12Hr(t.start)}</td><td>${to12Hr(t.end)}</td><td>${t.duration}</td><td>${t.extraHr}</td><td>${t.totalKM}</td><td>${t.extraKM}</td></tr>
      </table>
      <div class="section-title">Billing</div>
      <table class="invoice-table">
        <tr><th>Package</th><th>Extra Hr â‚¹</th><th>Extra KM â‚¹</th><th>Toll â‚¹</th><th>Parking â‚¹</th><th>Total â‚¹</th></tr>
        <tr><td>â‚¹${t.pkg}</td><td>â‚¹${t.hrCost}</td><td>â‚¹${t.kmCost}</td><td>â‚¹${t.toll}</td><td>â‚¹${t.park}</td><td><strong>â‚¹${t.total}</strong></td></tr>
      </table>
      <div class="section-title">Note</div>
      <div>${t.note || "-"}</div>
      <br>
      <div><b>Customer Signature:</b><br><img src="${t.customerSign || ''}" style="max-width:300px; height:auto; border:1px solid #000;"/></div>
      <div><b>Driver Signature:</b><br><img src="${t.driverSign || ''}" style="max-width:300px; height:auto; border:1px solid #000;"/></div>
      <br><center><i>ğŸ™ Thank you for choosing NST Travels</i></center>
    </div>`;

    let printWindow = window.open('', '', 'width=800,height=600');
    printWindow.document.write(`<html><head><title>${t.id}</title>
    <style>
      body { font-family: 'Segoe UI'; background: white; color: #000; padding: 20px; }
      .invoice-table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 16px; }
      .invoice-table th, .invoice-table td { border: 1px solid #000; padding: 8px; text-align: left; }
      .invoice-table th { background: #f0f0f0; }
      .invoice { margin-bottom: 30px; page-break-after: always; padding: 15px; border: 2px solid #000; }
      .section-title { font-weight: bold; margin-top: 15px; }
    </style></head><body>${content}</body></html>`);
    printWindow.document.close();

    // Auto-download on open (optional):
    printWindow.print();
  });
}

let signs = getSignatureData();

let trip = {
  id: tripId.value || genId(),
  ...
  ...signs
};
