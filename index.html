<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>NST Trip Sheet</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    body { font-family:'Poppins',sans-serif; margin:0 auto; padding:20px; max-width:800px; background:#f4f6f9 }
    h2 { color:#4b2aad }
    label { font-weight:bold; margin-top:10px; display:block }
    input, select, textarea, button {
      width:100%; padding:10px; margin:5px 0 15px;
      border:1px solid #ccc; border-radius:5px; font-size:16px
    }
    button { background:#4b2aad; color:#fff; border:none; cursor:pointer }
    button:hover { background:#3a208b }
    table { width:100%; border-collapse:collapse; margin-top:20px }
    table, th, td { border:1px solid #ddd }
    th, td { padding:8px; text-align:left }
    th { background:#4b2aad; color:#fff }
  </style>
</head>
<body>

<h2>üìù NST Trip Sheet</h2>

<label>Trip ID</label><input id="tripId" readonly>

<label>Date</label>
<div style="position:relative">
  <input type="text" id="tripDateDisplay" placeholder="Select Date" readonly style="cursor:pointer">
  <input type="date" id="tripDate" style="opacity:0;position:absolute;top:0;left:0;width:100%;height:100%;cursor:pointer">
</div>

<label>Customer Name</label><input id="custName">
<label>Customer Number</label><input id="custNumber">

<label>Driver Name</label><select id="driverName" onchange="syncDriver(true)"></select>
<label>Driver Number</label><select id="driverNumber" onchange="syncDriver(false)"></select>

<label>Vehicle Model</label><select id="vehicleModel" onchange="syncVehicle(true)"></select>
<label>Vehicle Number</label><select id="vehicleNo" onchange="syncVehicle(false)"></select>

<label>Start Time</label><input type="time" id="startTime" onchange="recalc()">
<label>End Time</label><input type="time" id="endTime" onchange="recalc()">
<label>Duration (hrs)</label><input id="duration" readonly>
<label>Extra Hours</label><input id="extraHours" readonly>
<label>Start KM</label><input type="number" id="startKM" onchange="recalc()">
<label>End KM</label><input type="number" id="endKM" onchange="recalc()">
<label>Total KM</label><input id="totalKM" readonly>
<label>Extra KM</label><input id="extraKM" readonly>

<label>Parking ‚Çπ</label><input type="number" id="parking" value="0">
<label>Toll ‚Çπ</label><input type="number" id="toll" value="0">

<label>Note</label><textarea id="note" rows="3" placeholder="Enter any trip notes..."></textarea>

<div style="margin-top:15px">
  <button onclick="shareWhatsApp()">üì§ Share via WhatsApp</button>
  <button onclick="showSharedTrips()">üìã View Shared Trips</button>
  <button onclick="exportSharedTrips()">üì• Export Shared Trips (Excel)</button>
  <button onclick="document.getElementById('adminLogin').style.display='block'" style="background:#6c757d">üîê Admin Panel</button>
</div>

<div id="sharedTripsList"></div>

<!-- Admin login modal -->
<div id="adminLogin" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:9999">
  <div style="background:white;max-width:300px;margin:100px auto;padding:20px;border-radius:10px;box-shadow:0 0 10px rgba(0,0,0,0.3)">
    <h3 style="margin-top:0">üîê Admin Login</h3>
    <label>Username</label><input type="text" id="adminUser" placeholder="Username">
    <label>Password</label><input type="password" id="adminPass" placeholder="Password">
    <button onclick="loginAdmin()">Login</button>
    <button onclick="document.getElementById('adminLogin').style.display='none'" style="background:#dc3545;margin-top:10px">Cancel</button>
  </div>
</div>

<script>
const SHKEY = "shared-trips";
let drivers = {}, vehicles = {};

// === Trip ID Logic ===
function genId() {
  let c = 1;
  while (localStorage.getItem("#NST" + String(c).padStart(3, "0")) === "used") c++;
  return "#NST" + String(c).padStart(3, "0");
}
function reserveNextId() {
  const id = tripId.value;
  localStorage.setItem(id, "used");
  tripId.value = genId(); // prepare next
}

// === Sync Dropdowns ===
function syncDriver(fromName) {
  if (fromName) driverNumber.value = drivers[driverName.value] || "";
  else for (let k in drivers) if (drivers[k] === driverNumber.value) driverName.value = k;
}
function syncVehicle(fromModel) {
  if (fromModel) vehicleNo.value = vehicles[vehicleModel.value] || "";
  else for (let k in vehicles) if (vehicles[k] === vehicleNo.value) vehicleModel.value = k;
  recalc();
}

// === Recalculate Time & KM ===
function recalc() {
  if (startTime.value && endTime.value) {
    let s = new Date(`1970-01-01T${startTime.value}`);
    let e = new Date(`1970-01-01T${endTime.value}`);
    let diff = (e - s) / 3600000;
    if (diff < 0) diff += 24;
    duration.value = Math.ceil(diff);
    let freeHours = 8;
    extraHours.value = duration.value > freeHours ? duration.value - freeHours : 0;
  }

  let tot = +endKM.value - +startKM.value;
  totalKM.value = tot > 0 ? tot : 0;
  let freeKM = parseInt(vehicleModel.dataset.freekm || "80");
  extraKM.value = tot > freeKM ? tot - freeKM : 0;
}

// === Date Display Format ===
tripDate.addEventListener("change", () => {
  const raw = tripDate.value;
  if (!raw) return;
  const d = new Date(raw);
  tripDateDisplay.value = d.toLocaleDateString("en-GB", {
    day: '2-digit', month: 'long', year: 'numeric', timeZone: 'Asia/Kolkata'
  });
  tripDateDisplay.dataset.raw = raw;
});

// === WhatsApp Share ===
function to12Hr(t) {
  if (!t) return "";
  const [h, m] = t.split(":");
  const d = new Date(); d.setHours(h, m);
  return d.toLocaleTimeString('en-IN', { hour: '2-digit', minute: '2-digit', hour12: true });
}
function shareWhatsApp() {
  const rawDate = tripDateDisplay.dataset.raw;
  if (!rawDate) return alert("Please select date first.");
  const data = {
    id: tripId.value,
    date: rawDate,
    custName: custName.value, custNo: custNumber.value,
    driverName: driverName.value, driverNo: driverNumber.value,
    model: vehicleModel.value, vehicleNo: vehicleNo.value,
    start: startTime.value, end: endTime.value,
    duration: duration.value, extraH: extraHours.value,
    totalKM: totalKM.value, extraKM: extraKM.value,
    parking: parking.value, toll: toll.value, note: note.value
  };
  const msg = `üìã *TRIP SUMMARY*\n\n*TRIP ID:* ${data.id}\n*DATE:* ${tripDateDisplay.value}\n\n` +
    `üë§ *CUSTOMER INFO*\n‚Ä¢ *Name:* ${data.custName}\n‚Ä¢ *Number:* ${data.custNo}\n\n` +
    `üë®‚Äç‚úàÔ∏è *DRIVER INFO*\n‚Ä¢ *Name:* ${data.driverName}\n‚Ä¢ *Number:* ${data.driverNo}\n\n` +
    `üöò *VEHICLE INFO*\n‚Ä¢ *Model:* ${data.model}\n‚Ä¢ *Vehicle No:* ${data.vehicleNo}\n\n` +
    `üïí *TIME & DISTANCE*\n‚Ä¢ *Start:* ${to12Hr(data.start)}\n‚Ä¢ *End:* ${to12Hr(data.end)}\n` +
    `‚Ä¢ *Duration:* ${data.duration} hrs\n‚Ä¢ *Extra Hrs:* ${data.extraH}\n` +
    `‚Ä¢ *Total KM:* ${data.totalKM} km\n‚Ä¢ *Extra KM:* ${data.extraKM} km\n\n` +
    `üí∞ *CHARGES*\n‚Ä¢ *Parking:* ‚Çπ${data.parking}\n‚Ä¢ *Toll:* ‚Çπ${data.toll}\n\n` +
    `üìù *Note:* ${data.note || "-"}`;

  window.open("https://wa.me/?text=" + encodeURIComponent(msg), "_blank");
  recordShare(data);
  reserveNextId();
}

// === Record Trip Locally ===
function recordShare(d) {
  const arr = JSON.parse(localStorage.getItem(SHKEY) || "[]");
  arr.push(d);
  localStorage.setItem(SHKEY, JSON.stringify(arr));
}

// === Show Shared Trip List ===
function showSharedTrips() {
  const arr = JSON.parse(localStorage.getItem(SHKEY) || "[]");
  const div = document.getElementById("sharedTripsList");
  if (!arr.length) return div.innerHTML = "<p>No trips shared.</p>";

  let html = `<h3>üìã Shared Trips</h3><table><tr>
<th>ID</th><th>Date</th><th>Customer</th><th>Driver</th><th>Vehicle</th><th>KM</th><th>Hrs</th></tr>`;
  arr.forEach(r => {
    html += `<tr>
<td>${r.id}</td><td>${tripDateDisplay.value}</td><td>${r.custName}</td><td>${r.driverName}</td>
<td>${r.model}</td><td>${r.totalKM}</td><td>${r.duration}</td></tr>`;
  });
  div.innerHTML = html + "</table>";
}

// === Export Excel ===
function exportSharedTrips() {
  const arr = JSON.parse(localStorage.getItem(SHKEY) || "[]");
  if (!arr.length) return alert("No trips to export.");
  const ws = XLSX.utils.json_to_sheet(arr);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "SharedTrips");
  XLSX.writeFile(wb, "NST_Shared_Trips.xlsx");
}

// === Admin Login ===
function loginAdmin() {
  if (adminUser.value === "admin" && adminPass.value === "1234") {
    window.location.href = "admin.html";
  } else {
    alert("‚ùå Invalid credentials");
  }
}

// === INIT on Load ===
(function init() {
  tripId.value = genId();

  // Load Drivers from localStorage
  let dstore = JSON.parse(localStorage.getItem("driver-master") || "[]");
  drivers = {}; // reset
  driverName.innerHTML = '<option value="">-- Select --</option>';
  driverNumber.innerHTML = '<option value="">-- Select --</option>';
  dstore.forEach(d => {
    drivers[d.name] = d.mobile;
    driverName.innerHTML += `<option>${d.name}</option>`;
    driverNumber.innerHTML += `<option>${d.mobile}</option>`;
  });

  // Load Vehicles from localStorage
  let vstore = JSON.parse(localStorage.getItem("vehicle-master") || "[]");
  vehicles = {};
  vehicleModel.innerHTML = '<option value="">-- Select --</option>';
  vehicleNo.innerHTML = '<option value="">-- Select --</option>';
  vstore.forEach(v => {
    vehicles[v.model] = v.number;
    vehicleModel.innerHTML += `<option>${v.model}</option>`;
    vehicleNo.innerHTML += `<option>${v.number}</option>`;
  });
})();
</script>

</body>
</html>