<body>
<h2>📝 NST Trip Sheet</h2>
<div id="mainForm">
  <label>Language</label>
  <select id="lang" onchange="switchLang()">
    <option value="en">English</option>
    <option value="ta">தமிழ்</option>
    <option value="hi">हिंदी</option>
  </select>

  <label>Trip ID</label><input id="tripId" readonly>
  <label>Date</label><input type="date" id="tripDate">
  <label>Customer Name</label><input id="custName">
  <label>Customer Number</label><input id="custNumber">
  <label>Driver Name</label><input id="driverName">
  <label>Driver Number</label><input id="driverNumber">

  <label>Vehicle Model</label>
  <select id="vehicleModel" onchange="sync(true)">
    <option value="">-- Select --</option>
    <option>Innova Crysta</option>
    <option>Innova Hycross</option>
    <option>Force Urbania</option>
  </select>

  <label>Vehicle Number</label>
  <select id="vehicleNo" onchange="sync(false)">
    <option value="">-- Select --</option>
    <option>PY05N0505</option>
    <option>PY01DB1007</option>
    <option>TN14AP2084</option>
  </select>

  <label>Start Time</label><input type="time" id="startTime" onchange="recalc()">
  <label>End Time</label><input type="time" id="endTime" onchange="recalc()">
  <label>Duration (hrs)</label><input id="duration" readonly>
  <label>Extra Hours</label><input id="extraHours" readonly>

  <label>Start KM</label><input type="number" id="startKM" onchange="recalc()">
  <label>End KM</label><input type="number" id="endKM" onchange="recalc()">
  <label>Total KM</label><input id="totalKM" readonly>
  <label>Extra KM</label><input id="extraKM" readonly>

  <label>Package ₹</label><input id="packageCost" readonly>
  <label>Extra Hr ₹</label><input id="extraHrCost" readonly>
  <label>Extra KM ₹</label><input id="extraKmCost" readonly>
  <label>Toll ₹</label><input type="number" id="toll" value="0" onchange="recalc()">
  <label>Parking ₹</label><input type="number" id="parking" value="0" onchange="recalc()">
  <label>Total ₹</label><input id="totalCost" readonly>
  <label>Note</label><textarea id="note" rows="3" placeholder="Enter notes..."></textarea>

  <!-- Signatures -->
  <label>Customer Signature</label>
  <canvas id="custSign" width="300" height="80" style="border:1px solid #ccc;"></canvas>
  <button type="button" onclick="clearSignature('custSign')">Clear Signature</button>

  <label>Driver Signature</label>
  <canvas id="driverSign" width="300" height="80" style="border:1px solid #ccc;"></canvas>
  <button type="button" onclick="clearSignature('driverSign')">Clear Signature</button>

  <input type="hidden" id="eHr">
  <input type="hidden" id="eKm">
  <input type="hidden" id="freeKm">

  <div class="btn-group">
    <button onclick="saveTrip()">💾 Save</button>
    <button onclick="showTrips()">📑 View All</button>
    <button onclick="shareLast()">📤 WhatsApp</button>
    <button onclick="exportPDF()">📄 Export PDF</button>
    <button onclick="repeatLast()">🔁 Repeat Trip</button>
  </div>
  <div class="btn-group">
    <button onclick="openDashboard()">📊 Dashboard</button>
    <button onclick="openCalendar()">📆 Calendar</button>
    <button onclick="exportBackup()">💾 Export JSON</button>
    <button onclick="importBackup()">📥 Import JSON</button>
    <button onclick="openRates()">✏️ Edit Rates</button>
  </div>
</div>

<!-- Add SignaturePad script in <head> -->
<script src="https://cdn.jsdelivr.net/npm/signature_pad@4.1.6/dist/signature_pad.umd.min.js"></script>

<script>
let langData = {
  en: {
    title: "NST Trip Sheet",
    customerName: "Customer Name",
    driverName: "Driver Name",
    total: "Total ₹",
    note: "Note"
  },
  ta: {
    title: "NST பயண படிவம்",
    customerName: "வாடிக்கையாளர் பெயர்",
    driverName: "ஓட்டுனர் பெயர்",
    total: "மொத்தம் ₹",
    note: "குறிப்பு"
  },
  hi: {
    title: "NST यात्रा फ़ॉर्म",
    customerName: "ग्राहक का नाम",
    driverName: "चालक का नाम",
    total: "कुल ₹",
    note: "टिप्पणी"
  }
};

function switchLang() {
  let lang = langSelect.value || 'en';
  let l = langData[lang] || langData.en;
  document.querySelector('h2').textContent = "📝 " + l.title;
  document.querySelector("label[for=custName]").textContent = l.customerName;
  document.querySelector("label[for=driverName]").textContent = l.driverName;
  document.querySelector("label[for=totalCost]").textContent = l.total;
  document.querySelector("label[for=note]").textContent = l.note;
}

let custPad = new SignaturePad(document.getElementById("custSign"));
let driverPad = new SignaturePad(document.getElementById("driverSign"));

function clearSignature(id) {
  if (id === 'custSign') custPad.clear();
  if (id === 'driverSign') driverPad.clear();
}

function getSignatureData() {
  return {
    customerSign: custPad.isEmpty() ? "" : custPad.toDataURL(),
    driverSign: driverPad.isEmpty() ? "" : driverPad.toDataURL()
  };
}

function loadSignature(data) {
  if (data.customerSign) custPad.fromDataURL(data.customerSign);
  if (data.driverSign) driverPad.fromDataURL(data.driverSign);
}

function repeatLast() {
  let arr = JSON.parse(localStorage.getItem(TKEY) || '[]');
  if (arr.length === 0) return;
  let last = arr[arr.length - 1];
  editingId = null;
  tripId.value = genId();
  tripDate.value = new Date().toISOString().split('T')[0];
  custName.value = last.cust;
  custNumber.value = last.custNum;
  driverName.value = last.driver;
  driverNumber.value = last.driverNum;
  vehicleModel.value = last.model;
  vehicleNo.value = last.no;
  startTime.value = last.start;
  endTime.value = last.end;
  startKM.value = last.startKM;
  endKM.value = last.endKM;
  note.value = last.note;
  sync(true);
  recalc();
}

function exportBackup() {
  const data = localStorage.getItem(TKEY);
  const blob = new Blob([data], { type: "application/json" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "NST_Trip_Backup.json";
  a.click();
  URL.revokeObjectURL(url);
}

function importBackup() {
  const input = document.createElement("input");
  input.type = "file";
  input.accept = "application/json";
  input.onchange = e => {
    const file = e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = function(event) {
      try {
        const imported = JSON.parse(event.target.result);
        if (Array.isArray(imported)) {
          localStorage.setItem(TKEY, JSON.stringify(imported));
          alert("Trips imported successfully.");
        }
      } catch (e) {
        alert("Invalid JSON file.");
      }
    };
    reader.readAsText(file);
  };
  input.click();
}

function openDashboard() {
  alert("📊 Dashboard feature coming in Part 3");
}

function openCalendar() {
  alert("📆 Calendar view coming in Part 4");
}
</script>
