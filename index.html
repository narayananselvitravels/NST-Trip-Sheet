<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>NST Trip Sheet</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <style>
    body {
      font-family: 'Poppins', sans-serif;
      margin: 0 auto;
      padding: 20px;
      max-width: 800px;
      background: #f4f6f9;
    }
    label {
      font-weight: bold;
      margin-top: 10px;
      display: block;
    }
    input, select, textarea, button {
      width: 100%;
      padding: 10px;
      margin: 5px 0 15px 0;
      border: 1px solid #ccc;
      border-radius: 5px;
      font-size: 16px;
    }
    button {
      background: #4b2aad;
      color: white;
      border: none;
      cursor: pointer;
    }
    button:hover {
      background: #351c8a;
    }
    .btn-group {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }
    .trip-card {
      background: white;
      border: 1px solid #ccc;
      border-radius: 10px;
      padding: 15px;
      margin-bottom: 10px;
    }
    .trip-actions {
      display: flex;
      gap: 10px;
      margin-top: 10px;
      flex-wrap: wrap;
    }
    .popup, .ratePopup {
      display: none;
      position: fixed;
      top: 5%;
      left: 50%;
      transform: translateX(-50%);
      width: 95%;
      max-width: 800px;
      max-height: 90vh;
      overflow-y: auto;
      background: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 0 10px rgba(0,0,0,0.3);
      z-index: 1000;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
      font-size: 15px;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 8px;
      text-align: left;
    }
    th {
      background: #4b2aad;
      color: white;
    }
    #printContent { display: none; }
    @media print {
      body * { visibility: hidden; }
      #printContent, #printContent * { visibility: visible; }
      #printContent {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
      }
    }
  </style>
</head>
<body>
<h2>üìù NST Trip Sheet</h2>
<div id="mainForm">
  <label>Trip ID</label><input id="tripId" readonly>
  <label>Date</label><input type="date" id="tripDate">
  <label>Customer Name</label><input id="custName">
  <label>Customer Number</label><input id="custNumber">
  <label>Driver Name</label><input id="driverName">
  <label>Driver Number</label><input id="driverNumber">
  <label>Vehicle Model</label>
  <select id="vehicleModel" onchange="sync(true)">
    <option value="">-- Select --</option>
    <option>Innova Crysta</option>
    <option>Innova Hycross</option>
    <option>Force Urbania</option>
  </select>
  <label>Vehicle Number</label>
  <select id="vehicleNo" onchange="sync(false)">
    <option value="">-- Select --</option>
    <option>PY05N0505</option>
    <option>PY01DB1007</option>
    <option>TN14AP2084</option>
  </select>
  <label>Start Time</label><input type="time" id="startTime" onchange="recalc()">
  <label>End Time</label><input type="time" id="endTime" onchange="recalc()">
  <label>Duration (hrs)</label><input id="duration" readonly>
  <label>Extra Hours</label><input id="extraHours" readonly>
  <label>Start KM</label><input type="number" id="startKM" onchange="recalc()">
  <label>End KM</label><input type="number" id="endKM" onchange="recalc()">
  <label>Total KM</label><input id="totalKM" readonly>
  <label>Extra KM</label><input id="extraKM" readonly>
  <label>Package ‚Çπ</label><input id="packageCost" readonly>
  <label>Extra Hr ‚Çπ</label><input id="extraHrCost" readonly>
  <label>Extra KM ‚Çπ</label><input id="extraKmCost" readonly>
  <label>Toll ‚Çπ</label><input type="number" id="toll" value="0" onchange="recalc()">
  <label>Parking ‚Çπ</label><input type="number" id="parking" value="0" onchange="recalc()">
  <label>Total ‚Çπ</label><input id="totalCost" readonly>
  <label>Note</label><textarea id="note" rows="3" placeholder="Enter notes..."></textarea>
  <input type="hidden" id="eHr">
  <input type="hidden" id="eKm">
  <input type="hidden" id="freeKm">
  <div class="btn-group">
    <button onclick="saveTrip()">üíæ Save</button>
    <button onclick="showTrips()">üìë View All</button>
    <button onclick="shareLast()">üì§ WhatsApp</button>
    <button onclick="exportPDF()">üìÑ Export PDF</button>
  </div>
  <button style="margin-top:15px;" onclick="openRates()">‚úèÔ∏è Edit Rates</button>
</div>

<div class="popup" id="tripPopup">
  <h3>üìã All Trips</h3>
  <div id="tripList"></div>
  <button onclick="tripPopup.style.display='none'">Close</button>
</div>

<div class="ratePopup" id="ratePopup">
  <h3>‚úèÔ∏è Edit Vehicle Rates</h3>
  <table>
    <thead><tr><th>Model</th><th>Package ‚Çπ</th><th>Extra Hr ‚Çπ</th><th>Extra KM ‚Çπ</th><th>Free KM</th></tr></thead>
    <tbody id="rateRows"></tbody>
  </table>
  <button onclick="saveRates()">Save Rates</button>
  <button onclick="ratePopup.style.display='none'">Cancel</button>
</div>

<div id="printContent"></div>

<script>
let RKEY = 'nst-rates', TKEY = 'nst-trips';
let rates = JSON.parse(localStorage.getItem(RKEY)) || {
  "Innova Crysta": { pkg: 7500, hr: 1000, km: 20, free: 80, no: "PY05N0505" },
  "Innova Hycross": { pkg: 8500, hr: 1200, km: 24, free: 60, no: "PY01DB1007" },
  "Force Urbania": { pkg: 9500, hr: 1500, km: 26, free: 70, no: "TN14AP2084" }
};

function exportPDF() {
  const t = JSON.parse(localStorage.getItem(TKEY) || '[]').slice(-1)[0];
  if (!t) return alert("No trip found.");

  const content = document.createElement("div");
  content.style.padding = "40px";
  content.style.fontFamily = "Poppins, sans-serif";
  content.style.maxWidth = "800px";
  content.style.margin = "auto";
  content.style.background = "white";
  content.innerHTML = `
    <h1 style="color:#4b2aad; border-bottom:2px solid #4b2aad; padding-bottom:10px;">NST Travels - Invoice</h1>
    <p><strong>Invoice No:</strong> ${t.id} &nbsp;&nbsp;&nbsp; <strong>Date:</strong> ${formatDate(t.date)}</p>

    <table style="width:100%; margin-top:20px; font-size:14px">
      <tr>
        <td><strong>Customer Name:</strong> ${t.cust}<br><strong>Mobile:</strong> ${t.custNum}<br><strong>Owner:</strong> NST Travels<br><strong>Owner Mobile:</strong> +91-9876543210</td>
        <td><strong>Driver Name:</strong> ${t.driver}<br><strong>Mobile:</strong> ${t.driverNum}<br><strong>Vehicle Model:</strong> ${t.model}<br><strong>Vehicle No:</strong> ${t.no}</td>
      </tr>
    </table>

    <h3 style="color:#4b2aad; margin-top:30px;">Trip Info</h3>
    <table style="width:100%; font-size:14px">
      <tr>
        <td><strong>Pickup:</strong> -</td>
        <td><strong>Drop:</strong> -</td>
        <td><strong>Trip Date:</strong> ${formatDate(t.date)}</td>
      </tr>
      <tr>
        <td><strong>Start Time:</strong> ${to12Hr(t.start)}</td>
        <td><strong>End Time:</strong> ${to12Hr(t.end)}</td>
        <td><strong>Duration:</strong> ${t.duration} hrs</td>
      </tr>
    </table>

    <h3 style="color:#4b2aad; margin-top:30px;">Billing Summary</h3>
    <table style="width:100%; border-collapse:collapse; font-size:14px" border="1">
      <thead>
        <tr style="background:#4b2aad; color:white">
          <th>Description</th><th>Rate</th><th>Units</th><th>Amount</th>
        </tr>
      </thead>
      <tbody>
        <tr><td>Package</td><td>‚Çπ${t.pkg}</td><td>1</td><td>‚Çπ${t.pkg}</td></tr>
        <tr><td>Extra Hours</td><td>‚Çπ${t.hrCost / t.extraHr || 0}</td><td>${t.extraHr}</td><td>‚Çπ${t.hrCost}</td></tr>
        <tr><td>Extra KM</td><td>‚Çπ${t.kmCost / t.extraKM || 0}</td><td>${t.extraKM}</td><td>‚Çπ${t.kmCost}</td></tr>
        <tr><td>Toll</td><td>-</td><td>-</td><td>‚Çπ${t.toll}</td></tr>
        <tr><td>Parking</td><td>-</td><td>-</td><td>‚Çπ${t.park}</td></tr>
        <tr style="font-weight:bold"><td colspan="3">Total Fare</td><td>‚Çπ${t.total}</td></tr>
      </tbody>
    </table>

    <p style="margin-top:20px"><strong>Total in Words:</strong> Rs ${t.total} only.</p>

    <div style="margin-top:50px; display:flex; justify-content:space-between;">
      <div>Customer Signature</div>
      <div>Authorized Signature</div>
    </div>

    <p style="margin-top:30px; text-align:center; font-size:13px; color:#555">Thank you for choosing NST Travels. Have a safe journey!</p>

    <div style="margin-top:20px; text-align:center">
      <button onclick="window.print()">üñ®Ô∏è Print or Save as PDF</button>
      <button onclick="downloadPDFImage()">üìÑ Export PDF</button>
      <button onclick="downloadImage()">üì∏ Share as Image</button>
    </div>
  `;

  document.body.appendChild(content);
  content.id = "printContent";
  html2canvas(content).then(canvas => {
    const imgData = canvas.toDataURL("image/png");
    const { jsPDF } = window.jspdf;
    const pdf = new jsPDF({ orientation: "portrait", unit: "mm", format: "a4" });
    const pageWidth = pdf.internal.pageSize.getWidth();
    const pageHeight = pdf.internal.pageSize.getHeight();
    const imgProps = pdf.getImageProperties(imgData);
    const ratio = imgProps.width / imgProps.height;
    const pdfWidth = pageWidth;
    const pdfHeight = pageWidth / ratio;
    pdf.addImage(imgData, "PNG", 0, 0, pdfWidth, pdfHeight);
    pdf.save(`${t.id}.pdf`);
    content.remove();
  });
}

function downloadImage() {
  const content = document.getElementById("printContent");
  html2canvas(content).then(canvas => {
    const link = document.createElement("a");
    link.download = `${document.getElementById("tripId").value}.png`;
    link.href = canvas.toDataURL();
    link.click();
  });
}

function to12Hr(timeStr) {
  const [h, m] = timeStr.split(":"), hour = parseInt(h);
  const suffix = hour >= 12 ? "PM" : "AM";
  return `${hour % 12 || 12}:${m} ${suffix}`;
}

function formatDate(dateStr) {
  if (!dateStr) return "";
  const d = new Date(dateStr);
  return `${String(d.getDate()).padStart(2, '0')}-${String(d.getMonth() + 1).padStart(2, '0')}-${d.getFullYear()}`;
}
</script>
