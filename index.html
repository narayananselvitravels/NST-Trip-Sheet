<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>NST Trip Sheet</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, sans-serif;
      margin: 0 auto;
      padding: 20px;
      max-width: 960px;
      background: #f4f6f9;
    }
    label {
      font-weight: bold;
      margin-top: 10px;
      display: block;
    }
    input, select, textarea, button {
      width: 100%;
      padding: 10px;
      margin: 5px 0 15px 0;
      border: 1px solid #ccc;
      border-radius: 5px;
      font-size: 16px;
    }
    button {
      background: #007bff;
      color: white;
      border: none;
      cursor: pointer;
    }
    button:hover {
      background: #0056b3;
    }
    .btn-group {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }
    .trip-card {
      background: white;
      border: 1px solid #ccc;
      border-radius: 10px;
      padding: 15px;
      margin-bottom: 10px;
    }
    .trip-actions {
      display: flex;
      gap: 10px;
      margin-top: 10px;
      flex-wrap: wrap;
    }
    .popup, .admin-panel {
      display: none;
      position: fixed;
      top: 5%;
      left: 50%;
      transform: translateX(-50%);
      width: 95%;
      max-width: 900px;
      max-height: 90vh;
      overflow-y: auto;
      background: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 0 10px rgba(0,0,0,0.3);
      z-index: 1000;
    }
    .admin-login {
      max-width: 400px;
      margin: 40px auto;
      background: #fff;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 0 8px rgba(0,0,0,0.1);
    }
    .table-responsive {
      overflow-x: auto;
      width: 100%;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
      font-size: 15px;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 8px;
      text-align: left;
      white-space: nowrap;
    }
    th {
      background: #007bff;
      color: white;
    }
    .admin-panel h3 { margin-top: 0; }
    .admin-buttons { margin-top: 20px; display: flex; gap: 10px; flex-wrap: wrap; }
    @media print {
      body * { visibility: hidden; }
      #printContent, #printContent * { visibility: visible; }
      #printContent { position: absolute; top: 0; left: 0; width: 100%; }
    }
    @media (max-width: 600px) {
      input, select, textarea, button {
        font-size: 14px;
        padding: 8px;
      }
      label, table { font-size: 14px; }
    }
  </style>
</head>
<body>
<h2>üìù NST Trip Sheet</h2>

<div id="mainForm">
  <label>Trip ID</label><input id="tripId" readonly>
  <label>Date</label><input type="date" id="tripDate">
  <label>Customer Name</label><input id="custName">
  <label>Customer Number</label><input id="custNumber">
  <label>Driver Name</label>
  <select id="driverName" onchange="syncDriver(true)">
    <option value="">-- Select --</option>
    <option>Perumal</option>
    <option>Siva</option>
  </select>
  <label>Driver Number</label>
  <select id="driverNumber" onchange="syncDriver(false)">
    <option value="">-- Select --</option>
    <option>9699994563</option>
    <option>9551208961</option>
  </select>
  <label>Vehicle Model</label>
  <select id="vehicleModel" onchange="syncVehicle(true)">
    <option value="">-- Select --</option>
    <option>Innova Crysta</option>
    <option>Innova Hycross</option>
    <option>Force Urbania</option>
  </select>
  <label>Vehicle Number</label>
  <select id="vehicleNo" onchange="syncVehicle(false)">
    <option value="">-- Select --</option>
    <option>PY05N0505</option>
    <option>PY01DB1007</option>
    <option>TN14AP2084</option>
  </select>
  <label>Start Time</label><input type="time" id="startTime" onchange="recalc()">
  <label>End Time</label><input type="time" id="endTime" onchange="recalc()">
  <label>Duration (hrs)</label><input id="duration" readonly>
  <label>Extra Hours</label><input id="extraHours" readonly>
  <label>Start KM</label><input type="number" id="startKM" onchange="recalc()">
  <label>End KM</label><input type="number" id="endKM" onchange="recalc()">
  <label>Total KM</label><input id="totalKM" readonly>
  <label>Extra KM</label><input id="extraKM" readonly>
  <label>Parking ‚Çπ</label><input type="number" id="parking" value="0" onchange="recalc()">
  <label>Toll ‚Çπ</label><input type="number" id="toll" value="0" onchange="recalc()">
  <label>Note</label><textarea id="note" rows="3" placeholder="Enter notes..."></textarea>
  <input type="hidden" id="eHr">
  <input type="hidden" id="eKm">
  <input type="hidden" id="freeKm">

  <div class="btn-group">
    <button onclick="saveTrip()">üíæ Save</button>
    <button onclick="showTrips()">üìë View All</button>
    <button onclick="shareLast()">üì§ Share</button>
    <button onclick="goToAdmin()">‚öôÔ∏è Admin Panel</button>
  </div>
</div>

<!-- Shared Trips Popup -->
<div class="popup" id="tripPopup">
  <h3>üìã All Trips</h3>
  <div id="tripList"></div>
  <button onclick="tripPopup.style.display='none'">Close</button>
</div>

<!-- Admin Login & Panel -->
<div class="admin-login" id="adminLogin">
  <h3>üîê Admin Login</h3>
  <label>Username</label>
  <input id="adminUser" placeholder="Enter Username">
  <label>Password</label>
  <input id="adminPass" type="password" placeholder="Enter Password">
  <button onclick="loginAdmin()">Login</button>
</div>

<div class="admin-panel" id="adminPanel">
  <h3>‚öôÔ∏è Admin Panel</h3>
  <div class="admin-buttons">
    <button onclick="openRates()">‚úèÔ∏è Edit Vehicle Rates</button>
    <button onclick="resetTrips()">üóëÔ∏è Reset All Trips</button>
    <button onclick="resetTripId()">üîÅ Reset Trip ID</button>
    <button onclick="adminPanel.style.display='none'">Close Panel</button>
  </div>
  <div id="ratePopup" style="margin-top:20px;"></div>
</div>

<!-- Dynamic Print Content -->
<div id="printContent"></div>

<script>
let RKEY = 'nst-rates', TKEY = 'nst-trips', SIDKEY = 'nst-shared-ids', tripCounter = 1;
let rates = JSON.parse(localStorage.getItem(RKEY)) || {
  "Innova Crysta": { pkg: 7500, hr: 1000, km: 20, free: 80, no: "PY05N0505" },
  "Innova Hycross": { pkg: 8500, hr: 1200, km: 24, free: 60, no: "PY01DB1007" },
  "Force Urbania": { pkg: 9500, hr: 1500, km: 26, free: 70, no: "TN14AP2084" }
};
let drivers = {
  "Perumal": "9699994563",
  "Siva": "9551208961"
};
let editingId = null;
let sharedIds = JSON.parse(localStorage.getItem(SIDKEY) || "[]");

function syncVehicle(fromModel) {
  if (fromModel) {
    let model = vehicleModel.value;
    if (rates[model]) {
      vehicleNo.value = rates[model].no;
      eHr.value = rates[model].hr;
      eKm.value = rates[model].km;
      freeKm.value = rates[model].free;
    }
  } else {
    let no = vehicleNo.value;
    for (let model in rates) {
      if (rates[model].no === no) {
        vehicleModel.value = model;
        syncVehicle(true);
        break;
      }
    }
  }
  recalc();
}
function syncDriver(fromName) {
  if (fromName) {
    driverNumber.value = drivers[driverName.value] || '';
  } else {
    driverName.value = Object.keys(drivers).find(name => drivers[name] === driverNumber.value) || '';
  }
}
function to12Hr(timeStr) {
  if (!timeStr) return "";
  const [h, m] = timeStr.split(":");
  let hour = parseInt(h);
  let suffix = hour >= 12 ? "PM" : "AM";
  hour = hour % 12 || 12;
  return `${hour}:${m} ${suffix}`;
}
function formatDateDisplay(dateStr) {
  const d = new Date(dateStr);
  return d.toLocaleDateString("en-GB", { day: "2-digit", month: "long", year: "numeric" });
}
function formatDateShare(dateStr) {
  const d = new Date(dateStr);
  return d.toLocaleDateString("en-GB");
}

function recalc() {
  if (startTime.value && endTime.value) {
    let s = new Date(`1970-01-01T${startTime.value}`);
    let e = new Date(`1970-01-01T${endTime.value}`);
    let diff = (e - s) / 3600000;
    if (diff < 0) diff += 24;
    let hrs = Math.ceil(diff);
    duration.value = hrs;
    extraHours.value = hrs > 8 ? hrs - 8 : 0;
  }

  let totKm = endKM.value - startKM.value;
  totalKM.value = totKm;
  extraKM.value = totKm > freeKm.value ? totKm - freeKm.value : 0;
}

function genId() {
  let arr = JSON.parse(localStorage.getItem(TKEY) || '[]');
  for (let i = 1; i <= 999; i++) {
    let id = "#NST" + String(i).padStart(3, '0');
    if (!arr.find(t => t.id === id)) return id;
  }
  return "#NST999";
}

function saveTrip() {
  let trip = {
    id: tripId.value || genId(),
    date: tripDate.value,
    note: note.value,
    cust: custName.value,
    custNum: custNumber.value,
    driver: driverName.value,
    driverNum: driverNumber.value,
    model: vehicleModel.value,
    no: vehicleNo.value,
    start: startTime.value,
    end: endTime.value,
    duration: duration.value,
    extraHr: extraHours.value,
    startKM: startKM.value,
    endKM: endKM.value,
    totalKM: totalKM.value,
    extraKM: extraKM.value,
    toll: toll.value,
    park: parking.value
  };
  let arr = JSON.parse(localStorage.getItem(TKEY) || '[]');
  if (editingId) {
    let i = arr.findIndex(t => t.id === editingId);
    if (i >= 0) arr[i] = trip;
    editingId = null;
  } else {
    arr.push(trip);
  }
  localStorage.setItem(TKEY, JSON.stringify(arr));
  clearForm();
}

function clearForm() {
  document.querySelectorAll('#mainForm input, #mainForm select, #mainForm textarea').forEach(el => el.value = '');
  tripId.value = genId();
}

function showTrips() {
  let arr = JSON.parse(localStorage.getItem(TKEY) || '[]');
  tripList.innerHTML = arr.map(t => `
    <div class="trip-card">
      <b>${t.id}</b> (${formatDateDisplay(t.date)})<br>
      ${t.model} - ${t.no}<br>
      ${to12Hr(t.start)} ‚Üí ${to12Hr(t.end)} (${t.duration}h)<br>
      Extra Hr: ${t.extraHr} | Extra KM: ${t.extraKM}<br>
      <b>Parking:</b> ‚Çπ${t.park} | <b>Toll:</b> ‚Çπ${t.toll}<br>
      <div class="trip-actions">
        <button onclick="editTrip('${t.id}')">‚úèÔ∏è Edit</button>
        <button onclick="deleteTrip('${t.id}')">‚ùå Delete</button>
        <button onclick="shareTrip('${t.id}')">üì§ Share</button>
      </div>
    </div>
  `).join('') || 'No trips yet';
  tripPopup.style.display = 'block';
}

function shareTrip(id) {
  let arr = JSON.parse(localStorage.getItem(TKEY) || '[]');
  let t = arr.find(x => x.id === id);
  if (!t) return;

  let msg = `üìã *TRIP SUMMARY*\n\n*TRIP ID:* ${t.id}\n*DATE:* ${formatDateShare(t.date)}\n\nüë§ *CUSTOMER INFO*\n‚Ä¢ Name: ${t.cust}\n‚Ä¢ Number: ${t.custNum}\n\nüë®‚Äç‚úà *DRIVER INFO*\n‚Ä¢ Name: ${t.driver}\n‚Ä¢ Number: ${t.driverNum}\n\nüöò *VEHICLE INFO*\n‚Ä¢ Model: ${t.model}\n‚Ä¢ Vehicle No: ${t.no}\n\nüïí *TIME & DISTANCE*\n‚Ä¢ Start Time: ${to12Hr(t.start)}\n‚Ä¢ End Time: ${to12Hr(t.end)}\n‚Ä¢ Duration: ${t.duration} hrs\n‚Ä¢ Extra Hrs: ${t.extraHr}\n‚Ä¢ Total KM: ${t.totalKM} km\n‚Ä¢ Extra KM: ${t.extraKM} km\n\n‚Ä¢ Parking: ‚Çπ${t.park}\n‚Ä¢ Toll: ‚Çπ${t.toll}\n\nüìù *Note:* ${t.note || '-'}`;

  window.open("https://wa.me/?text=" + encodeURIComponent(msg));
  if (!sharedIds.includes(t.id)) {
    sharedIds.push(t.id);
    localStorage.setItem(SIDKEY, JSON.stringify(sharedIds));
  }
  tripId.value = genId();
}

function shareLast() {
  let arr = JSON.parse(localStorage.getItem(TKEY) || '[]');
  if (arr.length) shareTrip(arr[arr.length - 1].id);
}

function openRates() {
  let html = `<h4>Edit Vehicle Rates</h4><table><tr><th>Model</th><th>Package</th><th>Extra Hr</th><th>Extra KM</th><th>Free KM</th></tr>`;
  for (let m in rates) {
    let r = rates[m];
    html += `<tr>
      <td>${m}</td>
      <td><input type="number" value="${r.pkg}" onchange="rates['${m}'].pkg=this.value"></td>
      <td><input type="number" value="${r.hr}" onchange="rates['${m}'].hr=this.value"></td>
      <td><input type="number" value="${r.km}" onchange="rates['${m}'].km=this.value"></td>
      <td><input type="number" value="${r.free}" onchange="rates['${m}'].free=this.value"></td>
    </tr>`;
  }
  html += `</table><button onclick="saveRates()">Save Rates</button>`;
  ratePopup.innerHTML = html;
  adminPanel.style.display = 'block';
}

function saveRates() {
  localStorage.setItem(RKEY, JSON.stringify(rates));
  alert("Rates Saved!");
}

function resetTrips() {
  if (confirm("Clear all saved trips?")) {
    localStorage.removeItem(TKEY);
    localStorage.removeItem(SIDKEY);
    alert("All trips reset.");
  }
}
function resetTripId() {
  tripId.value = "#NST001";
  alert("Trip ID reset to #NST001");
}

function goToAdmin() {
  adminLogin.style.display = 'block';
}
function loginAdmin() {
  if (adminUser.value === "admin" && adminPass.value === "1234") {
    adminLogin.style.display = 'none';
    adminPanel.style.display = 'block';
  } else {
    alert("Invalid credentials");
  }
}

tripId.value = genId();
</script>
</body>
</html>